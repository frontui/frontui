/*! 
*  frontui v1.3.5
*  by frontpay FE Team
*  (c) 2016-08-17 www.frontpay.cn
*  Licensed under Apache License
*/
!function(root,factory){var origin,modules={},_require=function(deps,callback){var args,len,i;if("string"==typeof deps)return getModule(deps);for(args=[],len=deps.length,i=0;len>i;i++)args.push(getModule(deps[i]));return callback.apply(null,args)},_define=function(id,deps,factory){2===arguments.length&&(factory=deps,deps=null),_require(deps||[],function(){setModule(id,factory,arguments)})},setModule=function(id,factory,args){var returned,module={exports:factory};"function"==typeof factory&&(args.length||(args=[_require,module.exports,module]),returned=factory.apply(null,args),void 0!==returned&&(module.exports=returned)),modules[id]=module.exports},getModule=function(id){var module=modules[id]||root[id];if(!module)throw new Error("`"+id+"` is undefined");return module},exportsTo=function(obj){var key,host,parts,part,last,ucFirst;ucFirst=function(str){return str&&str.charAt(0).toUpperCase()+str.substr(1)};for(key in modules)if(host=obj,modules.hasOwnProperty(key)){for(parts=key.split("/"),last=ucFirst(parts.pop());part=ucFirst(parts.shift());)host[part]=host[part]||{},host=host[part];host[last]=modules[key]}return obj},makeExport=function(dollar){return root.__dollar=dollar,exportsTo(factory(root,_define,_require))};"object"==typeof module&&"object"==typeof module.exports?module.exports=makeExport():"function"==typeof define&&define.amd?define(["jquery"],makeExport):(origin=root.WebUploader,root.WebUploader=makeExport(),root.WebUploader.noConflict=function(){root.WebUploader=origin})}(window,function(window,define,require){return define("dollar-third",[],function(){var req=window.require,$=window.__dollar||window.jQuery||window.Zepto||req("jquery")||req("zepto");if(!$)throw new Error("jQuery or Zepto not found!");return $}),define("dollar",["dollar-third"],function(_){return _}),define("promise-third",["dollar"],function($){return{Deferred:$.Deferred,when:$.when,isPromise:function(anything){return anything&&"function"==typeof anything.then}}}),define("promise",["promise-third"],function(_){return _}),define("base",["dollar","promise"],function($,promise){function uncurryThis(fn){return function(){return call.apply(fn,arguments)}}function bindFn(fn,context){return function(){return fn.apply(context,arguments)}}function createObject(proto){var f;return Object.create?Object.create(proto):(f=function(){},f.prototype=proto,new f)}var noop=function(){},call=Function.call;return{version:"0.1.6",$:$,Deferred:promise.Deferred,isPromise:promise.isPromise,when:promise.when,browser:function(ua){var ret={},webkit=ua.match(/WebKit\/([\d.]+)/),chrome=ua.match(/Chrome\/([\d.]+)/)||ua.match(/CriOS\/([\d.]+)/),ie=ua.match(/MSIE\s([\d\.]+)/)||ua.match(/(?:trident)(?:.*rv:([\w.]+))?/i),firefox=ua.match(/Firefox\/([\d.]+)/),safari=ua.match(/Safari\/([\d.]+)/),opera=ua.match(/OPR\/([\d.]+)/);return webkit&&(ret.webkit=parseFloat(webkit[1])),chrome&&(ret.chrome=parseFloat(chrome[1])),ie&&(ret.ie=parseFloat(ie[1])),firefox&&(ret.firefox=parseFloat(firefox[1])),safari&&(ret.safari=parseFloat(safari[1])),opera&&(ret.opera=parseFloat(opera[1])),ret}(navigator.userAgent),os:function(ua){var ret={},android=ua.match(/(?:Android);?[\s\/]+([\d.]+)?/),ios=ua.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);return android&&(ret.android=parseFloat(android[1])),ios&&(ret.ios=parseFloat(ios[1].replace(/_/g,"."))),ret}(navigator.userAgent),inherits:function(Super,protos,staticProtos){var child;return"function"==typeof protos?(child=protos,protos=null):child=protos&&protos.hasOwnProperty("constructor")?protos.constructor:function(){return Super.apply(this,arguments)},$.extend(!0,child,Super,staticProtos||{}),child.__super__=Super.prototype,child.prototype=createObject(Super.prototype),protos&&$.extend(!0,child.prototype,protos),child},noop:noop,bindFn:bindFn,log:function(){return window.console?bindFn(console.log,console):noop}(),nextTick:function(){return function(cb){setTimeout(cb,1)}}(),slice:uncurryThis([].slice),guid:function(){var counter=0;return function(prefix){for(var guid=(+new Date).toString(32),i=0;5>i;i++)guid+=Math.floor(65535*Math.random()).toString(32);return(prefix||"wu_")+guid+(counter++).toString(32)}}(),formatSize:function(size,pointLength,units){var unit;for(units=units||["B","K","M","G","TB"];(unit=units.shift())&&size>1024;)size/=1024;return("B"===unit?size:size.toFixed(pointLength||2))+unit}}}),define("mediator",["base"],function(Base){function findHandlers(arr,name,callback,context){return $.grep(arr,function(handler){return handler&&(!name||handler.e===name)&&(!callback||handler.cb===callback||handler.cb._cb===callback)&&(!context||handler.ctx===context)})}function eachEvent(events,callback,iterator){$.each((events||"").split(separator),function(_,key){iterator(key,callback)})}function triggerHanders(events,args){for(var handler,stoped=!1,i=-1,len=events.length;++i<len;)if(handler=events[i],handler.cb.apply(handler.ctx2,args)===!1){stoped=!0;break}return!stoped}var protos,$=Base.$,slice=[].slice,separator=/\s+/;return protos={on:function(name,callback,context){var set,me=this;return callback?(set=this._events||(this._events=[]),eachEvent(name,callback,function(name,callback){var handler={e:name};handler.cb=callback,handler.ctx=context,handler.ctx2=context||me,handler.id=set.length,set.push(handler)}),this):this},once:function(name,callback,context){var me=this;return callback?(eachEvent(name,callback,function(name,callback){var once=function(){return me.off(name,once),callback.apply(context||me,arguments)};once._cb=callback,me.on(name,once,context)}),me):me},off:function(name,cb,ctx){var events=this._events;return events?name||cb||ctx?(eachEvent(name,cb,function(name,cb){$.each(findHandlers(events,name,cb,ctx),function(){delete events[this.id]})}),this):(this._events=[],this):this},trigger:function(type){var args,events,allEvents;return this._events&&type?(args=slice.call(arguments,1),events=findHandlers(this._events,type),allEvents=findHandlers(this._events,"all"),triggerHanders(events,args)&&triggerHanders(allEvents,arguments)):this}},$.extend({installTo:function(obj){return $.extend(obj,protos)}},protos)}),define("uploader",["base","mediator"],function(Base,Mediator){function Uploader(opts){this.options=$.extend(!0,{},Uploader.options,opts),this._init(this.options)}var $=Base.$;return Uploader.options={},Mediator.installTo(Uploader.prototype),$.each({upload:"start-upload",stop:"stop-upload",getFile:"get-file",getFiles:"get-files",addFile:"add-file",addFiles:"add-file",sort:"sort-files",removeFile:"remove-file",cancelFile:"cancel-file",skipFile:"skip-file",retry:"retry",isInProgress:"is-in-progress",makeThumb:"make-thumb",md5File:"md5-file",getDimension:"get-dimension",addButton:"add-btn",predictRuntimeType:"predict-runtime-type",refresh:"refresh",disable:"disable",enable:"enable",reset:"reset"},function(fn,command){Uploader.prototype[fn]=function(){return this.request(command,arguments)}}),$.extend(Uploader.prototype,{state:"pending",_init:function(opts){var me=this;me.request("init",opts,function(){me.state="ready",me.trigger("ready")})},option:function(key,val){var opts=this.options;return arguments.length>1?void($.isPlainObject(val)&&$.isPlainObject(opts[key])?$.extend(opts[key],val):opts[key]=val):key?opts[key]:opts},getStats:function(){var stats=this.request("get-stats");return stats?{successNum:stats.numOfSuccess,progressNum:stats.numOfProgress,cancelNum:stats.numOfCancel,invalidNum:stats.numOfInvalid,uploadFailNum:stats.numOfUploadFailed,queueNum:stats.numOfQueue,interruptNum:stats.numofInterrupt}:{}},trigger:function(type){var args=[].slice.call(arguments,1),opts=this.options,name="on"+type.substring(0,1).toUpperCase()+type.substring(1);return Mediator.trigger.apply(this,arguments)===!1||$.isFunction(opts[name])&&opts[name].apply(this,args)===!1||$.isFunction(this[name])&&this[name].apply(this,args)===!1||Mediator.trigger.apply(Mediator,[this,type].concat(args))===!1?!1:!0},destroy:function(){this.request("destroy",arguments),this.off()},request:Base.noop}),Base.create=Uploader.create=function(opts){return new Uploader(opts)},Base.Uploader=Uploader,Uploader}),define("runtime/runtime",["base","mediator"],function(Base,Mediator){function Runtime(options){this.options=$.extend({container:document.body},options),this.uid=Base.guid("rt_")}var $=Base.$,factories={},getFirstKey=function(obj){for(var key in obj)if(obj.hasOwnProperty(key))return key;return null};return $.extend(Runtime.prototype,{getContainer:function(){var parent,container,opts=this.options;return this._container?this._container:(parent=$(opts.container||document.body),container=$(document.createElement("div")),container.attr("id","rt_"+this.uid),container.css({position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"}),parent.append(container),parent.addClass("webuploader-container"),this._container=container,this._parent=parent,container)},init:Base.noop,exec:Base.noop,destroy:function(){this._container&&this._container.remove(),this._parent&&this._parent.removeClass("webuploader-container"),this.off()}}),Runtime.orders="html5,flash",Runtime.addRuntime=function(type,factory){factories[type]=factory},Runtime.hasRuntime=function(type){return!!(type?factories[type]:getFirstKey(factories))},Runtime.create=function(opts,orders){var type,runtime;if(orders=orders||Runtime.orders,$.each(orders.split(/\s*,\s*/g),function(){return factories[this]?(type=this,!1):void 0}),type=type||getFirstKey(factories),!type)throw new Error("Runtime Error");return runtime=new factories[type](opts)},Mediator.installTo(Runtime.prototype),Runtime}),define("runtime/client",["base","mediator","runtime/runtime"],function(Base,Mediator,Runtime){function RuntimeClient(component,standalone){var runtime,deferred=Base.Deferred();this.uid=Base.guid("client_"),this.runtimeReady=function(cb){return deferred.done(cb)},this.connectRuntime=function(opts,cb){if(runtime)throw new Error("already connected!");return deferred.done(cb),"string"==typeof opts&&cache.get(opts)&&(runtime=cache.get(opts)),runtime=runtime||cache.get(null,standalone),runtime?(Base.$.extend(runtime.options,opts),runtime.__promise.then(deferred.resolve),runtime.__client++):(runtime=Runtime.create(opts,opts.runtimeOrder),runtime.__promise=deferred.promise(),runtime.once("ready",deferred.resolve),runtime.init(),cache.add(runtime),runtime.__client=1),standalone&&(runtime.__standalone=standalone),runtime},this.getRuntime=function(){return runtime},this.disconnectRuntime=function(){runtime&&(runtime.__client--,runtime.__client<=0&&(cache.remove(runtime),delete runtime.__promise,runtime.destroy()),runtime=null)},this.exec=function(){if(runtime){var args=Base.slice(arguments);return component&&args.unshift(component),runtime.exec.apply(this,args)}},this.getRuid=function(){return runtime&&runtime.uid},this.destroy=function(destroy){return function(){destroy&&destroy.apply(this,arguments),this.trigger("destroy"),this.off(),this.exec("destroy"),this.disconnectRuntime()}}(this.destroy)}var cache;return cache=function(){var obj={};return{add:function(runtime){obj[runtime.uid]=runtime},get:function(ruid,standalone){var i;if(ruid)return obj[ruid];for(i in obj)if(!standalone||!obj[i].__standalone)return obj[i];return null},remove:function(runtime){delete obj[runtime.uid]}}}(),Mediator.installTo(RuntimeClient.prototype),RuntimeClient}),define("lib/dnd",["base","mediator","runtime/client"],function(Base,Mediator,RuntimeClent){function DragAndDrop(opts){opts=this.options=$.extend({},DragAndDrop.options,opts),opts.container=$(opts.container),opts.container.length&&RuntimeClent.call(this,"DragAndDrop")}var $=Base.$;return DragAndDrop.options={accept:null,disableGlobalDnd:!1},Base.inherits(RuntimeClent,{constructor:DragAndDrop,init:function(){var me=this;me.connectRuntime(me.options,function(){me.exec("init"),me.trigger("ready")})}}),Mediator.installTo(DragAndDrop.prototype),DragAndDrop}),define("widgets/widget",["base","uploader"],function(Base,Uploader){function isArrayLike(obj){if(!obj)return!1;var length=obj.length,type=$.type(obj);return 1===obj.nodeType&&length?!0:"array"===type||"function"!==type&&"string"!==type&&(0===length||"number"==typeof length&&length>0&&length-1 in obj)}function Widget(uploader){this.owner=uploader,this.options=uploader.options}var $=Base.$,_init=Uploader.prototype._init,_destroy=Uploader.prototype.destroy,IGNORE={},widgetClass=[];return $.extend(Widget.prototype,{init:Base.noop,invoke:function(apiName,args){var map=this.responseMap;return map&&apiName in map&&map[apiName]in this&&$.isFunction(this[map[apiName]])?this[map[apiName]].apply(this,args):IGNORE},request:function(){return this.owner.request.apply(this.owner,arguments)}}),$.extend(Uploader.prototype,{_init:function(){var me=this,widgets=me._widgets=[],deactives=me.options.disableWidgets||"";return $.each(widgetClass,function(_,klass){(!deactives||!~deactives.indexOf(klass._name))&&widgets.push(new klass(me))}),_init.apply(me,arguments)},request:function(apiName,args,callback){var widget,rlt,promise,key,i=0,widgets=this._widgets,len=widgets&&widgets.length,rlts=[],dfds=[];for(args=isArrayLike(args)?args:[args];len>i;i++)widget=widgets[i],rlt=widget.invoke(apiName,args),rlt!==IGNORE&&(Base.isPromise(rlt)?dfds.push(rlt):rlts.push(rlt));return callback||dfds.length?(promise=Base.when.apply(Base,dfds),key=promise.pipe?"pipe":"then",promise[key](function(){var deferred=Base.Deferred(),args=arguments;return 1===args.length&&(args=args[0]),setTimeout(function(){deferred.resolve(args)},1),deferred.promise()})[callback?key:"done"](callback||Base.noop)):rlts[0]},destroy:function(){_destroy.apply(this,arguments),this._widgets=null}}),Uploader.register=Widget.register=function(responseMap,widgetProto){var klass,map={init:"init",destroy:"destroy",name:"anonymous"};return 1===arguments.length?(widgetProto=responseMap,$.each(widgetProto,function(key){return"_"===key[0]||"name"===key?void("name"===key&&(map.name=widgetProto.name)):void(map[key.replace(/[A-Z]/g,"-$&").toLowerCase()]=key)})):map=$.extend(map,responseMap),widgetProto.responseMap=map,klass=Base.inherits(Widget,widgetProto),klass._name=map.name,widgetClass.push(klass),klass},Uploader.unRegister=Widget.unRegister=function(name){if(name&&"anonymous"!==name)for(var i=widgetClass.length;i--;)widgetClass[i]._name===name&&widgetClass.splice(i,1)},Widget}),define("widgets/filednd",["base","uploader","lib/dnd","widgets/widget"],function(Base,Uploader,Dnd){var $=Base.$;return Uploader.options.dnd="",Uploader.register({name:"dnd",init:function(opts){if(opts.dnd&&"html5"===this.request("predict-runtime-type")){var dnd,me=this,deferred=Base.Deferred(),options=$.extend({},{disableGlobalDnd:opts.disableGlobalDnd,container:opts.dnd,accept:opts.accept});return this.dnd=dnd=new Dnd(options),dnd.once("ready",deferred.resolve),dnd.on("drop",function(files){me.request("add-file",[files])}),dnd.on("accept",function(items){return me.owner.trigger("dndAccept",items)}),dnd.init(),deferred.promise()}},destroy:function(){this.dnd&&this.dnd.destroy()}})}),define("lib/filepaste",["base","mediator","runtime/client"],function(Base,Mediator,RuntimeClent){function FilePaste(opts){opts=this.options=$.extend({},opts),opts.container=$(opts.container||document.body),RuntimeClent.call(this,"FilePaste")}var $=Base.$;return Base.inherits(RuntimeClent,{constructor:FilePaste,init:function(){var me=this;me.connectRuntime(me.options,function(){me.exec("init"),me.trigger("ready")})}}),Mediator.installTo(FilePaste.prototype),FilePaste}),define("widgets/filepaste",["base","uploader","lib/filepaste","widgets/widget"],function(Base,Uploader,FilePaste){var $=Base.$;return Uploader.register({name:"paste",init:function(opts){if(opts.paste&&"html5"===this.request("predict-runtime-type")){var paste,me=this,deferred=Base.Deferred(),options=$.extend({},{container:opts.paste,accept:opts.accept});return this.paste=paste=new FilePaste(options),paste.once("ready",deferred.resolve),paste.on("paste",function(files){me.owner.request("add-file",[files])}),paste.init(),deferred.promise()}},destroy:function(){this.paste&&this.paste.destroy()}})}),define("lib/blob",["base","runtime/client"],function(Base,RuntimeClient){function Blob(ruid,source){var me=this;me.source=source,me.ruid=ruid,this.size=source.size||0,!source.type&&this.ext&&~"jpg,jpeg,png,gif,bmp".indexOf(this.ext)?this.type="image/"+("jpg"===this.ext?"jpeg":this.ext):this.type=source.type||"application/octet-stream",RuntimeClient.call(me,"Blob"),this.uid=source.uid||this.uid,ruid&&me.connectRuntime(ruid)}return Base.inherits(RuntimeClient,{constructor:Blob,slice:function(start,end){return this.exec("slice",start,end)},getSource:function(){return this.source}}),Blob}),define("lib/file",["base","lib/blob"],function(Base,Blob){function File(ruid,file){var ext;this.name=file.name||"untitled"+uid++,ext=rExt.exec(file.name)?RegExp.$1.toLowerCase():"",!ext&&file.type&&(ext=/\/(jpg|jpeg|png|gif|bmp)$/i.exec(file.type)?RegExp.$1.toLowerCase():"",this.name+="."+ext),this.ext=ext,this.lastModifiedDate=file.lastModifiedDate||(new Date).toLocaleString(),Blob.apply(this,arguments)}var uid=1,rExt=/\.([^.]+)$/;return Base.inherits(Blob,File)}),define("lib/filepicker",["base","runtime/client","lib/file"],function(Base,RuntimeClient,File){function FilePicker(opts){if(opts=this.options=$.extend({},FilePicker.options,opts),opts.container=$(opts.id),!opts.container.length)throw new Error("按钮指定错误");opts.innerHTML=opts.innerHTML||opts.label||opts.container.html()||"",opts.button=$(opts.button||document.createElement("div")),opts.button.html(opts.innerHTML),opts.container.html(opts.button),RuntimeClient.call(this,"FilePicker",!0)}var $=Base.$;return FilePicker.options={button:null,container:null,label:null,innerHTML:null,multiple:!0,accept:null,name:"file",style:"webuploader-pick"},Base.inherits(RuntimeClient,{constructor:FilePicker,init:function(){var me=this,opts=me.options,button=opts.button,style=opts.style;style&&button.addClass("webuploader-pick"),me.on("all",function(type){var files;switch(type){case"mouseenter":style&&button.addClass("webuploader-pick-hover");break;case"mouseleave":style&&button.removeClass("webuploader-pick-hover");break;case"change":files=me.exec("getFiles"),me.trigger("select",$.map(files,function(file){return file=new File(me.getRuid(),file),file._refer=opts.container,file}),opts.container)}}),me.connectRuntime(opts,function(){me.refresh(),me.exec("init",opts),me.trigger("ready")}),this._resizeHandler=Base.bindFn(this.refresh,this),$(window).on("resize",this._resizeHandler)},refresh:function(){var shimContainer=this.getRuntime().getContainer(),button=this.options.button,width=button.outerWidth?button.outerWidth():button.width(),height=button.outerHeight?button.outerHeight():button.height(),pos=button.offset();width&&height&&shimContainer.css({bottom:"auto",right:"auto",width:width+"px",height:height+"px"}).offset(pos)},enable:function(){var btn=this.options.button;btn.removeClass("webuploader-pick-disable"),this.refresh()},disable:function(){var btn=this.options.button;this.getRuntime().getContainer().css({top:"-99999px"}),btn.addClass("webuploader-pick-disable")},destroy:function(){var btn=this.options.button;$(window).off("resize",this._resizeHandler),btn.removeClass("webuploader-pick-disable webuploader-pick-hover webuploader-pick")}}),FilePicker}),define("widgets/filepicker",["base","uploader","lib/filepicker","widgets/widget"],function(Base,Uploader,FilePicker){var $=Base.$;return $.extend(Uploader.options,{pick:null,accept:null}),Uploader.register({name:"picker",init:function(opts){return this.pickers=[],opts.pick&&this.addBtn(opts.pick)},refresh:function(){$.each(this.pickers,function(){this.refresh()})},addBtn:function(pick){var me=this,opts=me.options,accept=opts.accept,promises=[];if(pick)return $.isPlainObject(pick)||(pick={id:pick}),$(pick.id).each(function(){var options,picker,deferred;deferred=Base.Deferred(),options=$.extend({},pick,{accept:$.isPlainObject(accept)?[accept]:accept,swf:opts.swf,runtimeOrder:opts.runtimeOrder,id:this}),picker=new FilePicker(options),picker.once("ready",deferred.resolve),picker.on("select",function(files){me.owner.request("add-file",[files])}),picker.on("dialogopen",function(){me.owner.trigger("dialogOpen",picker.button)}),picker.init(),me.pickers.push(picker),promises.push(deferred.promise())}),Base.when.apply(Base,promises)},disable:function(){$.each(this.pickers,function(){this.disable()})},enable:function(){$.each(this.pickers,function(){this.enable()})},destroy:function(){$.each(this.pickers,function(){this.destroy()}),this.pickers=null}})}),define("lib/image",["base","runtime/client","lib/blob"],function(Base,RuntimeClient,Blob){function Image(opts){this.options=$.extend({},Image.options,opts),RuntimeClient.call(this,"Image"),this.on("load",function(){this._info=this.exec("info"),this._meta=this.exec("meta")})}var $=Base.$;return Image.options={quality:90,crop:!1,preserveHeaders:!1,allowMagnify:!1},Base.inherits(RuntimeClient,{constructor:Image,info:function(val){return val?(this._info=val,this):this._info},meta:function(val){return val?(this._meta=val,this):this._meta},loadFromBlob:function(blob){var me=this,ruid=blob.getRuid();this.connectRuntime(ruid,function(){me.exec("init",me.options),me.exec("loadFromBlob",blob)})},resize:function(){var args=Base.slice(arguments);return this.exec.apply(this,["resize"].concat(args))},crop:function(){var args=Base.slice(arguments);return this.exec.apply(this,["crop"].concat(args))},getAsDataUrl:function(type){return this.exec("getAsDataUrl",type)},getAsBlob:function(type){var blob=this.exec("getAsBlob",type);return new Blob(this.getRuid(),blob)}}),Image}),define("widgets/image",["base","uploader","lib/image","widgets/widget"],function(Base,Uploader,Image){var throttle,$=Base.$;return throttle=function(max){var occupied=0,waiting=[],tick=function(){for(var item;waiting.length&&max>occupied;)item=waiting.shift(),occupied+=item[0],item[1]()};return function(emiter,size,cb){waiting.push([size,cb]),emiter.once("destroy",function(){occupied-=size,setTimeout(tick,1)}),setTimeout(tick,1)}}(5242880),$.extend(Uploader.options,{thumb:{width:110,height:110,quality:70,allowMagnify:!0,crop:!0,preserveHeaders:!1,type:"image/jpeg"},compress:{width:1600,height:1600,quality:90,allowMagnify:!1,crop:!1,preserveHeaders:!0}}),Uploader.register({name:"image",makeThumb:function(file,cb,width,height){var opts,image;return file=this.request("get-file",file),file.type.match(/^image/)?(opts=$.extend({},this.options.thumb),$.isPlainObject(width)&&(opts=$.extend(opts,width),width=null),width=width||opts.width,height=height||opts.height,image=new Image(opts),image.once("load",function(){file._info=file._info||image.info(),file._meta=file._meta||image.meta(),1>=width&&width>0&&(width=file._info.width*width),1>=height&&height>0&&(height=file._info.height*height),image.resize(width,height)}),image.once("complete",function(){cb(!1,image.getAsDataUrl(opts.type)),image.destroy()}),image.once("error",function(reason){cb(reason||!0),image.destroy()}),void throttle(image,file.source.size,function(){file._info&&image.info(file._info),file._meta&&image.meta(file._meta),image.loadFromBlob(file.source)})):void cb(!0)},beforeSendFile:function(file){var image,deferred,opts=this.options.compress||this.options.resize,compressSize=opts&&opts.compressSize||0,noCompressIfLarger=opts&&opts.noCompressIfLarger||!1;return file=this.request("get-file",file),!opts||!~"image/jpeg,image/jpg".indexOf(file.type)||file.size<compressSize||file._compressed?void 0:(opts=$.extend({},opts),deferred=Base.Deferred(),image=new Image(opts),deferred.always(function(){image.destroy(),image=null}),image.once("error",deferred.reject),image.once("load",function(){var width=opts.width,height=opts.height;file._info=file._info||image.info(),file._meta=file._meta||image.meta(),1>=width&&width>0&&(width=file._info.width*width),1>=height&&height>0&&(height=file._info.height*height),image.resize(width,height)}),image.once("complete",function(){var blob,size;try{blob=image.getAsBlob(opts.type),size=file.size,(!noCompressIfLarger||blob.size<size)&&(file.source=blob,file.size=blob.size,file.trigger("resize",blob.size,size)),file._compressed=!0,deferred.resolve()}catch(e){deferred.resolve()}}),file._info&&image.info(file._info),file._meta&&image.meta(file._meta),image.loadFromBlob(file.source),deferred.promise())}})}),define("file",["base","mediator"],function(Base,Mediator){function gid(){return idPrefix+idSuffix++}function WUFile(source){this.name=source.name||"Untitled",this.size=source.size||0,this.type=source.type||"application/octet-stream",this.lastModifiedDate=source.lastModifiedDate||1*new Date,this.id=gid(),this.ext=rExt.exec(this.name)?RegExp.$1:"",this.statusText="",statusMap[this.id]=WUFile.Status.INITED,this.source=source,this.loaded=0,this.on("error",function(msg){this.setStatus(WUFile.Status.ERROR,msg)})}var $=Base.$,idPrefix="WU_FILE_",idSuffix=0,rExt=/\.([^.]+)$/,statusMap={};return $.extend(WUFile.prototype,{setStatus:function(status,text){var prevStatus=statusMap[this.id];"undefined"!=typeof text&&(this.statusText=text),status!==prevStatus&&(statusMap[this.id]=status,this.trigger("statuschange",status,prevStatus))},getStatus:function(){return statusMap[this.id]},getSource:function(){return this.source},destroy:function(){this.off(),delete statusMap[this.id]}}),Mediator.installTo(WUFile.prototype),WUFile.Status={INITED:"inited",QUEUED:"queued",PROGRESS:"progress",ERROR:"error",COMPLETE:"complete",CANCELLED:"cancelled",INTERRUPT:"interrupt",INVALID:"invalid"},WUFile}),define("queue",["base","mediator","file"],function(Base,Mediator,WUFile){function Queue(){this.stats={numOfQueue:0,numOfSuccess:0,numOfCancel:0,numOfProgress:0,numOfUploadFailed:0,numOfInvalid:0,numofDeleted:0,numofInterrupt:0},this._queue=[],this._map={}}var $=Base.$,STATUS=WUFile.Status;return $.extend(Queue.prototype,{append:function(file){return this._queue.push(file),this._fileAdded(file),this},prepend:function(file){return this._queue.unshift(file),this._fileAdded(file),this},getFile:function(fileId){return"string"!=typeof fileId?fileId:this._map[fileId]},fetch:function(status){var i,file,len=this._queue.length;for(status=status||STATUS.QUEUED,i=0;len>i;i++)if(file=this._queue[i],status===file.getStatus())return file;return null},sort:function(fn){"function"==typeof fn&&this._queue.sort(fn)},getFiles:function(){for(var file,sts=[].slice.call(arguments,0),ret=[],i=0,len=this._queue.length;len>i;i++)file=this._queue[i],(!sts.length||~$.inArray(file.getStatus(),sts))&&ret.push(file);return ret},removeFile:function(file){var existing=this._map[file.id];existing&&(delete this._map[file.id],file.destroy(),this.stats.numofDeleted++)},_fileAdded:function(file){var me=this,existing=this._map[file.id];existing||(this._map[file.id]=file,file.on("statuschange",function(cur,pre){me._onFileStatusChange(cur,pre)}))},_onFileStatusChange:function(curStatus,preStatus){var stats=this.stats;switch(preStatus){case STATUS.PROGRESS:stats.numOfProgress--;break;case STATUS.QUEUED:stats.numOfQueue--;break;case STATUS.ERROR:stats.numOfUploadFailed--;break;case STATUS.INVALID:stats.numOfInvalid--;break;case STATUS.INTERRUPT:stats.numofInterrupt--}switch(curStatus){case STATUS.QUEUED:stats.numOfQueue++;break;case STATUS.PROGRESS:stats.numOfProgress++;break;case STATUS.ERROR:stats.numOfUploadFailed++;break;case STATUS.COMPLETE:stats.numOfSuccess++;break;case STATUS.CANCELLED:stats.numOfCancel++;break;case STATUS.INVALID:stats.numOfInvalid++;break;case STATUS.INTERRUPT:stats.numofInterrupt++}}}),Mediator.installTo(Queue.prototype),Queue}),define("widgets/queue",["base","uploader","queue","file","lib/file","runtime/client","widgets/widget"],function(Base,Uploader,Queue,WUFile,File,RuntimeClient){var $=Base.$,rExt=/\.\w+$/,Status=WUFile.Status;return Uploader.register({name:"queue",init:function(opts){var deferred,len,i,item,arr,accept,runtime,me=this;if($.isPlainObject(opts.accept)&&(opts.accept=[opts.accept]),opts.accept){for(arr=[],i=0,len=opts.accept.length;len>i;i++)item=opts.accept[i].extensions,item&&arr.push(item);arr.length&&(accept="\\."+arr.join(",").replace(/,/g,"$|\\.").replace(/\*/g,".*")+"$"),me.accept=new RegExp(accept,"i")}return me.queue=new Queue,me.stats=me.queue.stats,"html5"===this.request("predict-runtime-type")?(deferred=Base.Deferred(),this.placeholder=runtime=new RuntimeClient("Placeholder"),runtime.connectRuntime({runtimeOrder:"html5"},function(){me._ruid=runtime.getRuid(),deferred.resolve()}),deferred.promise()):void 0},_wrapFile:function(file){if(!(file instanceof WUFile)){if(!(file instanceof File)){if(!this._ruid)throw new Error("Can't add external files.");file=new File(this._ruid,file)}file=new WUFile(file)}return file},acceptFile:function(file){var invalid=!file||!file.size||this.accept&&rExt.exec(file.name)&&!this.accept.test(file.name);return!invalid},_addFile:function(file){var me=this;return file=me._wrapFile(file),me.owner.trigger("beforeFileQueued",file)?me.acceptFile(file)?(me.queue.append(file),me.owner.trigger("fileQueued",file),file):void me.owner.trigger("error","Q_TYPE_DENIED",file):void 0},getFile:function(fileId){return this.queue.getFile(fileId)},addFile:function(files){var me=this;files.length||(files=[files]),files=$.map(files,function(file){return me._addFile(file)}),files.length&&(me.owner.trigger("filesQueued",files),me.options.auto&&setTimeout(function(){me.request("start-upload")},20))},getStats:function(){return this.stats},removeFile:function(file,remove){var me=this;file=file.id?file:me.queue.getFile(file),this.request("cancel-file",file),remove&&this.queue.removeFile(file)},getFiles:function(){return this.queue.getFiles.apply(this.queue,arguments)},fetchFile:function(){return this.queue.fetch.apply(this.queue,arguments)},retry:function(file,noForceStart){var files,i,len,me=this;if(file)return file=file.id?file:me.queue.getFile(file),file.setStatus(Status.QUEUED),void(noForceStart||me.request("start-upload"));for(files=me.queue.getFiles(Status.ERROR),i=0,len=files.length;len>i;i++)file=files[i],file.setStatus(Status.QUEUED);me.request("start-upload")},sortFiles:function(){return this.queue.sort.apply(this.queue,arguments)},reset:function(){this.owner.trigger("reset"),this.queue=new Queue,this.stats=this.queue.stats},destroy:function(){this.reset(),this.placeholder&&this.placeholder.destroy()}})}),define("widgets/runtime",["uploader","runtime/runtime","widgets/widget"],function(Uploader,Runtime){return Uploader.support=function(){return Runtime.hasRuntime.apply(Runtime,arguments)},Uploader.register({name:"runtime",init:function(){if(!this.predictRuntimeType())throw Error("Runtime Error")},predictRuntimeType:function(){var i,len,orders=this.options.runtimeOrder||Runtime.orders,type=this.type;if(!type)for(orders=orders.split(/\s*,\s*/g),i=0,len=orders.length;len>i;i++)if(Runtime.hasRuntime(orders[i])){this.type=type=orders[i];break}return type}})}),define("lib/transport",["base","runtime/client","mediator"],function(Base,RuntimeClient,Mediator){function Transport(opts){var me=this;opts=me.options=$.extend(!0,{},Transport.options,opts||{}),RuntimeClient.call(this,"Transport"),this._blob=null,this._formData=opts.formData||{},this._headers=opts.headers||{},this.on("progress",this._timeout),this.on("load error",function(){me.trigger("progress",1),clearTimeout(me._timer)})}var $=Base.$;return Transport.options={server:"",method:"POST",withCredentials:!1,fileVal:"file",timeout:12e4,formData:{},headers:{},sendAsBinary:!1},$.extend(Transport.prototype,{appendBlob:function(key,blob,filename){var me=this,opts=me.options;me.getRuid()&&me.disconnectRuntime(),me.connectRuntime(blob.ruid,function(){me.exec("init")}),me._blob=blob,opts.fileVal=key||opts.fileVal,opts.filename=filename||opts.filename},append:function(key,value){"object"==typeof key?$.extend(this._formData,key):this._formData[key]=value},setRequestHeader:function(key,value){"object"==typeof key?$.extend(this._headers,key):this._headers[key]=value;
},send:function(method){this.exec("send",method),this._timeout()},abort:function(){return clearTimeout(this._timer),this.exec("abort")},destroy:function(){this.trigger("destroy"),this.off(),this.exec("destroy"),this.disconnectRuntime()},getResponse:function(){return this.exec("getResponse")},getResponseAsJson:function(){return this.exec("getResponseAsJson")},getStatus:function(){return this.exec("getStatus")},_timeout:function(){var me=this,duration=me.options.timeout;duration&&(clearTimeout(me._timer),me._timer=setTimeout(function(){me.abort(),me.trigger("error","timeout")},duration))}}),Mediator.installTo(Transport.prototype),Transport}),define("widgets/upload",["base","uploader","file","lib/transport","widgets/widget"],function(Base,Uploader,WUFile,Transport){function CuteFile(file,chunkSize){var len,api,pending=[],blob=file.source,total=blob.size,chunks=chunkSize?Math.ceil(total/chunkSize):1,start=0,index=0;for(api={file:file,has:function(){return!!pending.length},shift:function(){return pending.shift()},unshift:function(block){pending.unshift(block)}};chunks>index;)len=Math.min(chunkSize,total-start),pending.push({file:file,start:start,end:chunkSize?start+len:total,total:total,chunks:chunks,chunk:index++,cuted:api}),start+=len;return file.blocks=pending.concat(),file.remaning=pending.length,api}var $=Base.$,isPromise=Base.isPromise,Status=WUFile.Status;$.extend(Uploader.options,{prepareNextFile:!1,chunked:!1,chunkSize:5242880,chunkRetry:2,threads:3,formData:{}}),Uploader.register({name:"upload",init:function(){var owner=this.owner,me=this;this.runing=!1,this.progress=!1,owner.on("startUpload",function(){me.progress=!0}).on("uploadFinished",function(){me.progress=!1}),this.pool=[],this.stack=[],this.pending=[],this.remaning=0,this.__tick=Base.bindFn(this._tick,this),owner.on("uploadComplete",function(file){file.blocks&&$.each(file.blocks,function(_,v){v.transport&&(v.transport.abort(),v.transport.destroy()),delete v.transport}),delete file.blocks,delete file.remaning})},reset:function(){this.request("stop-upload",!0),this.runing=!1,this.pool=[],this.stack=[],this.pending=[],this.remaning=0,this._trigged=!1,this._promise=null},startUpload:function(file){var me=this;if($.each(me.request("get-files",Status.INVALID),function(){me.request("remove-file",this)}),file?(file=file.id?file:me.request("get-file",file),file.getStatus()===Status.INTERRUPT?(file.setStatus(Status.QUEUED),$.each(me.pool,function(_,v){v.file===file&&(v.transport&&v.transport.send(),file.setStatus(Status.PROGRESS))})):file.getStatus()!==Status.PROGRESS&&file.setStatus(Status.QUEUED)):$.each(me.request("get-files",[Status.INITED]),function(){this.setStatus(Status.QUEUED)}),me.runing)return Base.nextTick(me.__tick);me.runing=!0;var files=[];file||$.each(me.pool,function(_,v){var file=v.file;file.getStatus()===Status.INTERRUPT&&(me._trigged=!1,files.push(file),v.transport&&v.transport.send())}),$.each(files,function(){this.setStatus(Status.PROGRESS)}),file||$.each(me.request("get-files",Status.INTERRUPT),function(){this.setStatus(Status.PROGRESS)}),me._trigged=!1,Base.nextTick(me.__tick),me.owner.trigger("startUpload")},stopUpload:function(file,interrupt){var block,me=this;if(file===!0&&(interrupt=file,file=null),me.runing!==!1){if(file){if(file=file.id?file:me.request("get-file",file),file.getStatus()!==Status.PROGRESS&&file.getStatus()!==Status.QUEUED)return;return file.setStatus(Status.INTERRUPT),$.each(me.pool,function(_,v){return v.file===file?(block=v,!1):void 0}),block.transport&&block.transport.abort(),interrupt&&(me._putback(block),me._popBlock(block)),Base.nextTick(me.__tick)}me.runing=!1,this._promise&&this._promise.file&&this._promise.file.setStatus(Status.INTERRUPT),interrupt&&$.each(me.pool,function(_,v){v.transport&&v.transport.abort(),v.file.setStatus(Status.INTERRUPT)}),me.owner.trigger("stopUpload")}},cancelFile:function(file){file=file.id?file:this.request("get-file",file),file.blocks&&$.each(file.blocks,function(_,v){var _tr=v.transport;_tr&&(_tr.abort(),_tr.destroy(),delete v.transport)}),file.setStatus(Status.CANCELLED),this.owner.trigger("fileDequeued",file)},isInProgress:function(){return!!this.progress},_getStats:function(){return this.request("get-stats")},skipFile:function(file,status){file=file.id?file:this.request("get-file",file),file.setStatus(status||Status.COMPLETE),file.skipped=!0,file.blocks&&$.each(file.blocks,function(_,v){var _tr=v.transport;_tr&&(_tr.abort(),_tr.destroy(),delete v.transport)}),this.owner.trigger("uploadSkip",file)},_tick:function(){var fn,val,me=this,opts=me.options;return me._promise?me._promise.always(me.__tick):void(me.pool.length<opts.threads&&(val=me._nextBlock())?(me._trigged=!1,fn=function(val){me._promise=null,val&&val.file&&me._startSend(val),Base.nextTick(me.__tick)},me._promise=isPromise(val)?val.always(fn):fn(val)):me.remaning||me._getStats().numOfQueue||me._getStats().numofInterrupt||(me.runing=!1,me._trigged||Base.nextTick(function(){me.owner.trigger("uploadFinished")}),me._trigged=!0))},_putback:function(block){var idx;block.cuted.unshift(block),idx=this.stack.indexOf(block.cuted),~idx||this.stack.unshift(block.cuted)},_getStack:function(){for(var act,i=0;act=this.stack[i++];){if(act.has()&&act.file.getStatus()===Status.PROGRESS)return act;(!act.has()||act.file.getStatus()!==Status.PROGRESS&&act.file.getStatus()!==Status.INTERRUPT)&&this.stack.splice(--i,1)}return null},_nextBlock:function(){var act,next,done,preparing,me=this,opts=me.options;return(act=this._getStack())?(opts.prepareNextFile&&!me.pending.length&&me._prepareNextFile(),act.shift()):me.runing?(!me.pending.length&&me._getStats().numOfQueue&&me._prepareNextFile(),next=me.pending.shift(),done=function(file){return file?(act=CuteFile(file,opts.chunked?opts.chunkSize:0),me.stack.push(act),act.shift()):null},isPromise(next)?(preparing=next.file,next=next[next.pipe?"pipe":"then"](done),next.file=preparing,next):done(next)):void 0},_prepareNextFile:function(){var promise,me=this,file=me.request("fetch-file"),pending=me.pending;file&&(promise=me.request("before-send-file",file,function(){return file.getStatus()===Status.PROGRESS||file.getStatus()===Status.INTERRUPT?file:me._finishFile(file)}),me.owner.trigger("uploadStart",file),file.setStatus(Status.PROGRESS),promise.file=file,promise.done(function(){var idx=$.inArray(promise,pending);~idx&&pending.splice(idx,1,file)}),promise.fail(function(reason){file.setStatus(Status.ERROR,reason),me.owner.trigger("uploadError",file,reason),me.owner.trigger("uploadComplete",file)}),pending.push(promise))},_popBlock:function(block){var idx=$.inArray(block,this.pool);this.pool.splice(idx,1),block.file.remaning--,this.remaning--},_startSend:function(block){var promise,me=this,file=block.file;return file.getStatus()!==Status.PROGRESS?void(file.getStatus()===Status.INTERRUPT&&me._putback(block)):(me.pool.push(block),me.remaning++,block.blob=1===block.chunks?file.source:file.source.slice(block.start,block.end),promise=me.request("before-send",block,function(){file.getStatus()===Status.PROGRESS?me._doSend(block):(me._popBlock(block),Base.nextTick(me.__tick))}),void promise.fail(function(){1===file.remaning?me._finishFile(file).always(function(){block.percentage=1,me._popBlock(block),me.owner.trigger("uploadComplete",file),Base.nextTick(me.__tick)}):(block.percentage=1,me.updateFileProgress(file),me._popBlock(block),Base.nextTick(me.__tick))}))},_doSend:function(block){var requestAccept,ret,me=this,owner=me.owner,opts=me.options,file=block.file,tr=new Transport(opts),data=$.extend({},opts.formData),headers=$.extend({},opts.headers);block.transport=tr,tr.on("destroy",function(){delete block.transport,me._popBlock(block),Base.nextTick(me.__tick)}),tr.on("progress",function(percentage){block.percentage=percentage,me.updateFileProgress(file)}),requestAccept=function(reject){var fn;return ret=tr.getResponseAsJson()||{},ret._raw=tr.getResponse(),fn=function(value){reject=value},owner.trigger("uploadAccept",block,ret,fn)||(reject=reject||"server"),reject},tr.on("error",function(type,flag){block.retried=block.retried||0,block.chunks>1&&~"http,abort".indexOf(type)&&block.retried<opts.chunkRetry?(block.retried++,tr.send()):(flag||"server"!==type||(type=requestAccept(type)),file.setStatus(Status.ERROR,type),owner.trigger("uploadError",file,type),owner.trigger("uploadComplete",file))}),tr.on("load",function(){var reason;return(reason=requestAccept())?void tr.trigger("error",reason,!0):void(1===file.remaning?me._finishFile(file,ret):tr.destroy())}),data=$.extend(data,{id:file.id,name:file.name,type:file.type,lastModifiedDate:file.lastModifiedDate,size:file.size}),block.chunks>1&&$.extend(data,{chunks:block.chunks,chunk:block.chunk}),owner.trigger("uploadBeforeSend",block,data,headers),tr.appendBlob(opts.fileVal,block.blob,file.name),tr.append(data),tr.setRequestHeader(headers),tr.send()},_finishFile:function(file,ret,hds){var owner=this.owner;return owner.request("after-send-file",arguments,function(){file.setStatus(Status.COMPLETE),owner.trigger("uploadSuccess",file,ret,hds)}).fail(function(reason){file.getStatus()===Status.PROGRESS&&file.setStatus(Status.ERROR,reason),owner.trigger("uploadError",file,reason)}).always(function(){owner.trigger("uploadComplete",file)})},updateFileProgress:function(file){var totalPercent=0,uploaded=0;file.blocks&&($.each(file.blocks,function(_,v){uploaded+=(v.percentage||0)*(v.end-v.start)}),totalPercent=uploaded/file.size,this.owner.trigger("uploadProgress",file,totalPercent||0))}})}),define("widgets/validator",["base","uploader","file","widgets/widget"],function(Base,Uploader,WUFile){var api,$=Base.$,validators={};return api={addValidator:function(type,cb){validators[type]=cb},removeValidator:function(type){delete validators[type]}},Uploader.register({name:"validator",init:function(){var me=this;Base.nextTick(function(){$.each(validators,function(){this.call(me.owner)})})}}),api.addValidator("fileNumLimit",function(){var uploader=this,opts=uploader.options,count=0,max=parseInt(opts.fileNumLimit,10),flag=!0;max&&(uploader.on("beforeFileQueued",function(file){return count>=max&&flag&&(flag=!1,this.trigger("error","Q_EXCEED_NUM_LIMIT",max,file),setTimeout(function(){flag=!0},1)),count>=max?!1:!0}),uploader.on("fileQueued",function(){count++}),uploader.on("fileDequeued",function(){count--}),uploader.on("reset",function(){count=0}))}),api.addValidator("fileSizeLimit",function(){var uploader=this,opts=uploader.options,count=0,max=parseInt(opts.fileSizeLimit,10),flag=!0;max&&(uploader.on("beforeFileQueued",function(file){var invalid=count+file.size>max;return invalid&&flag&&(flag=!1,this.trigger("error","Q_EXCEED_SIZE_LIMIT",max,file),setTimeout(function(){flag=!0},1)),invalid?!1:!0}),uploader.on("fileQueued",function(file){count+=file.size}),uploader.on("fileDequeued",function(file){count-=file.size}),uploader.on("reset",function(){count=0}))}),api.addValidator("fileSingleSizeLimit",function(){var uploader=this,opts=uploader.options,max=opts.fileSingleSizeLimit;max&&uploader.on("beforeFileQueued",function(file){return file.size>max?(file.setStatus(WUFile.Status.INVALID,"exceed_size"),this.trigger("error","F_EXCEED_SIZE",max,file),!1):void 0})}),api.addValidator("duplicate",function(){function hashString(str){for(var _char,hash=0,i=0,len=str.length;len>i;i++)_char=str.charCodeAt(i),hash=_char+(hash<<6)+(hash<<16)-hash;return hash}var uploader=this,opts=uploader.options,mapping={};opts.duplicate||(uploader.on("beforeFileQueued",function(file){var hash=file.__hash||(file.__hash=hashString(file.name+file.size+file.lastModifiedDate));return mapping[hash]?(this.trigger("error","F_DUPLICATE",file),!1):void 0}),uploader.on("fileQueued",function(file){var hash=file.__hash;hash&&(mapping[hash]=!0)}),uploader.on("fileDequeued",function(file){var hash=file.__hash;hash&&delete mapping[hash]}),uploader.on("reset",function(){mapping={}}))}),api}),define("lib/md5",["runtime/client","mediator"],function(RuntimeClient,Mediator){function Md5(){RuntimeClient.call(this,"Md5")}return Mediator.installTo(Md5.prototype),Md5.prototype.loadFromBlob=function(blob){var me=this;me.getRuid()&&me.disconnectRuntime(),me.connectRuntime(blob.ruid,function(){me.exec("init"),me.exec("loadFromBlob",blob)})},Md5.prototype.getResult=function(){return this.exec("getResult")},Md5}),define("widgets/md5",["base","uploader","lib/md5","lib/blob","widgets/widget"],function(Base,Uploader,Md5,Blob){return Uploader.register({name:"md5",md5File:function(file,start,end){var md5=new Md5,deferred=Base.Deferred(),blob=file instanceof Blob?file:this.request("get-file",file).source;return md5.on("progress load",function(e){e=e||{},deferred.notify(e.total?e.loaded/e.total:1)}),md5.on("complete",function(){deferred.resolve(md5.getResult())}),md5.on("error",function(reason){deferred.reject(reason)}),arguments.length>1&&(start=start||0,end=end||0,0>start&&(start=blob.size+start),0>end&&(end=blob.size+end),end=Math.min(end,blob.size),blob=blob.slice(start,end)),md5.loadFromBlob(blob),deferred.promise()}})}),define("runtime/compbase",[],function(){function CompBase(owner,runtime){this.owner=owner,this.options=owner.options,this.getRuntime=function(){return runtime},this.getRuid=function(){return runtime.uid},this.trigger=function(){return owner.trigger.apply(owner,arguments)}}return CompBase}),define("runtime/html5/runtime",["base","runtime/runtime","runtime/compbase"],function(Base,Runtime,CompBase){function Html5Runtime(){var pool={},me=this,destroy=this.destroy;Runtime.apply(me,arguments),me.type=type,me.exec=function(comp,fn){var instance,client=this,uid=client.uid,args=Base.slice(arguments,2);return components[comp]&&(instance=pool[uid]=pool[uid]||new components[comp](client,me),instance[fn])?instance[fn].apply(instance,args):void 0},me.destroy=function(){return destroy&&destroy.apply(this,arguments)}}var type="html5",components={};return Base.inherits(Runtime,{constructor:Html5Runtime,init:function(){var me=this;setTimeout(function(){me.trigger("ready")},1)}}),Html5Runtime.register=function(name,component){var klass=components[name]=Base.inherits(CompBase,component);return klass},window.Blob&&window.FileReader&&window.DataView&&Runtime.addRuntime(type,Html5Runtime),Html5Runtime}),define("runtime/html5/blob",["runtime/html5/runtime","lib/blob"],function(Html5Runtime,Blob){return Html5Runtime.register("Blob",{slice:function(start,end){var blob=this.owner.source,slice=blob.slice||blob.webkitSlice||blob.mozSlice;return blob=slice.call(blob,start,end),new Blob(this.getRuid(),blob)}})}),define("runtime/html5/dnd",["base","runtime/html5/runtime","lib/file"],function(Base,Html5Runtime,File){var $=Base.$,prefix="webuploader-dnd-";return Html5Runtime.register("DragAndDrop",{init:function(){var elem=this.elem=this.options.container;this.dragEnterHandler=Base.bindFn(this._dragEnterHandler,this),this.dragOverHandler=Base.bindFn(this._dragOverHandler,this),this.dragLeaveHandler=Base.bindFn(this._dragLeaveHandler,this),this.dropHandler=Base.bindFn(this._dropHandler,this),this.dndOver=!1,elem.on("dragenter",this.dragEnterHandler),elem.on("dragover",this.dragOverHandler),elem.on("dragleave",this.dragLeaveHandler),elem.on("drop",this.dropHandler),this.options.disableGlobalDnd&&($(document).on("dragover",this.dragOverHandler),$(document).on("drop",this.dropHandler))},_dragEnterHandler:function(e){var items,me=this,denied=me._denied||!1;return e=e.originalEvent||e,me.dndOver||(me.dndOver=!0,items=e.dataTransfer.items,items&&items.length&&(me._denied=denied=!me.trigger("accept",items)),me.elem.addClass(prefix+"over"),me.elem[denied?"addClass":"removeClass"](prefix+"denied")),e.dataTransfer.dropEffect=denied?"none":"copy",!1},_dragOverHandler:function(e){var parentElem=this.elem.parent().get(0);return parentElem&&!$.contains(parentElem,e.currentTarget)?!1:(clearTimeout(this._leaveTimer),this._dragEnterHandler.call(this,e),!1)},_dragLeaveHandler:function(){var handler,me=this;return handler=function(){me.dndOver=!1,me.elem.removeClass(prefix+"over "+prefix+"denied")},clearTimeout(me._leaveTimer),me._leaveTimer=setTimeout(handler,100),!1},_dropHandler:function(e){var dataTransfer,data,me=this,ruid=me.getRuid(),parentElem=me.elem.parent().get(0);if(parentElem&&!$.contains(parentElem,e.currentTarget))return!1;e=e.originalEvent||e,dataTransfer=e.dataTransfer;try{data=dataTransfer.getData("text/html")}catch(err){}return me.dndOver=!1,me.elem.removeClass(prefix+"over"),data?void 0:(me._getTansferFiles(dataTransfer,function(results){me.trigger("drop",$.map(results,function(file){return new File(ruid,file)}))}),!1)},_getTansferFiles:function(dataTransfer,callback){var items,files,file,item,i,len,canAccessFolder,results=[],promises=[];for(items=dataTransfer.items,files=dataTransfer.files,canAccessFolder=!(!items||!items[0].webkitGetAsEntry),i=0,len=files.length;len>i;i++)file=files[i],item=items&&items[i],canAccessFolder&&item.webkitGetAsEntry().isDirectory?promises.push(this._traverseDirectoryTree(item.webkitGetAsEntry(),results)):results.push(file);Base.when.apply(Base,promises).done(function(){results.length&&callback(results)})},_traverseDirectoryTree:function(entry,results){var deferred=Base.Deferred(),me=this;return entry.isFile?entry.file(function(file){results.push(file),deferred.resolve()}):entry.isDirectory&&entry.createReader().readEntries(function(entries){var i,len=entries.length,promises=[],arr=[];for(i=0;len>i;i++)promises.push(me._traverseDirectoryTree(entries[i],arr));Base.when.apply(Base,promises).then(function(){results.push.apply(results,arr),deferred.resolve()},deferred.reject)}),deferred.promise()},destroy:function(){var elem=this.elem;elem&&(elem.off("dragenter",this.dragEnterHandler),elem.off("dragover",this.dragOverHandler),elem.off("dragleave",this.dragLeaveHandler),elem.off("drop",this.dropHandler),this.options.disableGlobalDnd&&($(document).off("dragover",this.dragOverHandler),$(document).off("drop",this.dropHandler)))}})}),define("runtime/html5/filepaste",["base","runtime/html5/runtime","lib/file"],function(Base,Html5Runtime,File){return Html5Runtime.register("FilePaste",{init:function(){var arr,i,len,item,opts=this.options,elem=this.elem=opts.container,accept=".*";if(opts.accept){for(arr=[],i=0,len=opts.accept.length;len>i;i++)item=opts.accept[i].mimeTypes,item&&arr.push(item);arr.length&&(accept=arr.join(","),accept=accept.replace(/,/g,"|").replace(/\*/g,".*"))}this.accept=accept=new RegExp(accept,"i"),this.hander=Base.bindFn(this._pasteHander,this),elem.on("paste",this.hander)},_pasteHander:function(e){var items,item,blob,i,len,allowed=[],ruid=this.getRuid();for(e=e.originalEvent||e,items=e.clipboardData.items,i=0,len=items.length;len>i;i++)item=items[i],"file"===item.kind&&(blob=item.getAsFile())&&allowed.push(new File(ruid,blob));allowed.length&&(e.preventDefault(),e.stopPropagation(),this.trigger("paste",allowed))},destroy:function(){this.elem.off("paste",this.hander)}})}),define("runtime/html5/filepicker",["base","runtime/html5/runtime"],function(Base,Html5Runtime){var $=Base.$;return Html5Runtime.register("FilePicker",{init:function(){var arr,i,len,mouseHandler,container=this.getRuntime().getContainer(),me=this,owner=me.owner,opts=me.options,label=this.label=$(document.createElement("label")),input=this.input=$(document.createElement("input"));if(input.attr("type","file"),input.attr("capture","camera"),input.attr("name",opts.name),input.addClass("webuploader-element-invisible"),label.on("click",function(e){input.trigger("click"),e.stopPropagation(),owner.trigger("dialogopen")}),label.css({opacity:0,width:"100%",height:"100%",display:"block",cursor:"pointer",background:"#ffffff"}),opts.multiple&&input.attr("multiple","multiple"),opts.accept&&opts.accept.length>0){for(arr=[],i=0,len=opts.accept.length;len>i;i++)arr.push(opts.accept[i].mimeTypes);input.attr("accept",arr.join(","))}container.append(input),container.append(label),mouseHandler=function(e){owner.trigger(e.type)},input.on("change",function(e){var clone,fn=arguments.callee;me.files=e.target.files,clone=this.cloneNode(!0),clone.value=null,this.parentNode.replaceChild(clone,this),input.off(),input=$(clone).on("change",fn).on("mouseenter mouseleave",mouseHandler),owner.trigger("change")}),label.on("mouseenter mouseleave",mouseHandler)},getFiles:function(){return this.files},destroy:function(){this.input.off(),this.label.off()}})}),define("runtime/html5/util",["base"],function(Base){var urlAPI=window.createObjectURL&&window||window.URL&&URL.revokeObjectURL&&URL||window.webkitURL,createObjectURL=Base.noop,revokeObjectURL=createObjectURL;return urlAPI&&(createObjectURL=function(){return urlAPI.createObjectURL.apply(urlAPI,arguments)},revokeObjectURL=function(){return urlAPI.revokeObjectURL.apply(urlAPI,arguments)}),{createObjectURL:createObjectURL,revokeObjectURL:revokeObjectURL,dataURL2Blob:function(dataURI){var byteStr,intArray,ab,i,mimetype,parts;for(parts=dataURI.split(","),byteStr=~parts[0].indexOf("base64")?atob(parts[1]):decodeURIComponent(parts[1]),ab=new ArrayBuffer(byteStr.length),intArray=new Uint8Array(ab),i=0;i<byteStr.length;i++)intArray[i]=byteStr.charCodeAt(i);return mimetype=parts[0].split(":")[1].split(";")[0],this.arrayBufferToBlob(ab,mimetype)},dataURL2ArrayBuffer:function(dataURI){var byteStr,intArray,i,parts;for(parts=dataURI.split(","),byteStr=~parts[0].indexOf("base64")?atob(parts[1]):decodeURIComponent(parts[1]),intArray=new Uint8Array(byteStr.length),i=0;i<byteStr.length;i++)intArray[i]=byteStr.charCodeAt(i);return intArray.buffer},arrayBufferToBlob:function(buffer,type){var bb,builder=window.BlobBuilder||window.WebKitBlobBuilder;return builder?(bb=new builder,bb.append(buffer),bb.getBlob(type)):new Blob([buffer],type?{type:type}:{})},canvasToDataUrl:function(canvas,type,quality){return canvas.toDataURL(type,quality/100)},parseMeta:function(blob,callback){callback(!1,{})},updateImageHead:function(data){return data}}}),define("runtime/html5/imagemeta",["runtime/html5/util"],function(Util){var api;return api={parsers:{65505:[]},maxMetaDataSize:262144,parse:function(blob,cb){var me=this,fr=new FileReader;fr.onload=function(){cb(!1,me._parse(this.result)),fr=fr.onload=fr.onerror=null},fr.onerror=function(e){cb(e.message),fr=fr.onload=fr.onerror=null},blob=blob.slice(0,me.maxMetaDataSize),fr.readAsArrayBuffer(blob.getSource())},_parse:function(buffer,noParse){if(!(buffer.byteLength<6)){var markerBytes,markerLength,parsers,i,dataview=new DataView(buffer),offset=2,maxOffset=dataview.byteLength-4,headLength=offset,ret={};if(65496===dataview.getUint16(0)){for(;maxOffset>offset&&(markerBytes=dataview.getUint16(offset),markerBytes>=65504&&65519>=markerBytes||65534===markerBytes)&&(markerLength=dataview.getUint16(offset+2)+2,!(offset+markerLength>dataview.byteLength));){if(parsers=api.parsers[markerBytes],!noParse&&parsers)for(i=0;i<parsers.length;i+=1)parsers[i].call(api,dataview,offset,markerLength,ret);offset+=markerLength,headLength=offset}headLength>6&&(buffer.slice?ret.imageHead=buffer.slice(2,headLength):ret.imageHead=new Uint8Array(buffer).subarray(2,headLength))}return ret}},updateImageHead:function(buffer,head){var buf1,buf2,bodyoffset,data=this._parse(buffer,!0);return bodyoffset=2,data.imageHead&&(bodyoffset=2+data.imageHead.byteLength),buf2=buffer.slice?buffer.slice(bodyoffset):new Uint8Array(buffer).subarray(bodyoffset),buf1=new Uint8Array(head.byteLength+2+buf2.byteLength),buf1[0]=255,buf1[1]=216,buf1.set(new Uint8Array(head),2),buf1.set(new Uint8Array(buf2),head.byteLength+2),buf1.buffer}},Util.parseMeta=function(){return api.parse.apply(api,arguments)},Util.updateImageHead=function(){return api.updateImageHead.apply(api,arguments)},api}),define("runtime/html5/imagemeta/exif",["base","runtime/html5/imagemeta"],function(Base,ImageMeta){var EXIF={};return EXIF.ExifMap=function(){return this},EXIF.ExifMap.prototype.map={Orientation:274},EXIF.ExifMap.prototype.get=function(id){return this[id]||this[this.map[id]]},EXIF.exifTagTypes={1:{getValue:function(dataView,dataOffset){return dataView.getUint8(dataOffset)},size:1},2:{getValue:function(dataView,dataOffset){return String.fromCharCode(dataView.getUint8(dataOffset))},size:1,ascii:!0},3:{getValue:function(dataView,dataOffset,littleEndian){return dataView.getUint16(dataOffset,littleEndian)},size:2},4:{getValue:function(dataView,dataOffset,littleEndian){return dataView.getUint32(dataOffset,littleEndian)},size:4},5:{getValue:function(dataView,dataOffset,littleEndian){return dataView.getUint32(dataOffset,littleEndian)/dataView.getUint32(dataOffset+4,littleEndian)},size:8},9:{getValue:function(dataView,dataOffset,littleEndian){return dataView.getInt32(dataOffset,littleEndian)},size:4},10:{getValue:function(dataView,dataOffset,littleEndian){return dataView.getInt32(dataOffset,littleEndian)/dataView.getInt32(dataOffset+4,littleEndian)},size:8}},EXIF.exifTagTypes[7]=EXIF.exifTagTypes[1],EXIF.getExifValue=function(dataView,tiffOffset,offset,type,length,littleEndian){var tagSize,dataOffset,values,i,str,c,tagType=EXIF.exifTagTypes[type];if(!tagType)return void Base.log("Invalid Exif data: Invalid tag type.");if(tagSize=tagType.size*length,dataOffset=tagSize>4?tiffOffset+dataView.getUint32(offset+8,littleEndian):offset+8,dataOffset+tagSize>dataView.byteLength)return void Base.log("Invalid Exif data: Invalid data offset.");if(1===length)return tagType.getValue(dataView,dataOffset,littleEndian);for(values=[],i=0;length>i;i+=1)values[i]=tagType.getValue(dataView,dataOffset+i*tagType.size,littleEndian);if(tagType.ascii){for(str="",i=0;i<values.length&&(c=values[i],"\x00"!==c);i+=1)str+=c;return str}return values},EXIF.parseExifTag=function(dataView,tiffOffset,offset,littleEndian,data){var tag=dataView.getUint16(offset,littleEndian);data.exif[tag]=EXIF.getExifValue(dataView,tiffOffset,offset,dataView.getUint16(offset+2,littleEndian),dataView.getUint32(offset+4,littleEndian),littleEndian)},EXIF.parseExifTags=function(dataView,tiffOffset,dirOffset,littleEndian,data){var tagsNumber,dirEndOffset,i;if(dirOffset+6>dataView.byteLength)return void Base.log("Invalid Exif data: Invalid directory offset.");if(tagsNumber=dataView.getUint16(dirOffset,littleEndian),dirEndOffset=dirOffset+2+12*tagsNumber,dirEndOffset+4>dataView.byteLength)return void Base.log("Invalid Exif data: Invalid directory size.");for(i=0;tagsNumber>i;i+=1)this.parseExifTag(dataView,tiffOffset,dirOffset+2+12*i,littleEndian,data);return dataView.getUint32(dirEndOffset,littleEndian)},EXIF.parseExifData=function(dataView,offset,length,data){var littleEndian,dirOffset,tiffOffset=offset+10;if(1165519206===dataView.getUint32(offset+4)){if(tiffOffset+8>dataView.byteLength)return void Base.log("Invalid Exif data: Invalid segment size.");if(0!==dataView.getUint16(offset+8))return void Base.log("Invalid Exif data: Missing byte alignment offset.");switch(dataView.getUint16(tiffOffset)){case 18761:littleEndian=!0;break;case 19789:littleEndian=!1;break;default:return void Base.log("Invalid Exif data: Invalid byte alignment marker.")}if(42!==dataView.getUint16(tiffOffset+2,littleEndian))return void Base.log("Invalid Exif data: Missing TIFF marker.");dirOffset=dataView.getUint32(tiffOffset+4,littleEndian),data.exif=new EXIF.ExifMap,dirOffset=EXIF.parseExifTags(dataView,tiffOffset,tiffOffset+dirOffset,littleEndian,data)}},ImageMeta.parsers[65505].push(EXIF.parseExifData),EXIF}),define("runtime/html5/jpegencoder",[],function(require,exports,module){function JPEGEncoder(quality){function initQuantTables(sf){for(var YQT=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],i=0;64>i;i++){var t=ffloor((YQT[i]*sf+50)/100);1>t?t=1:t>255&&(t=255),YTable[ZigZag[i]]=t}for(var UVQT=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],j=0;64>j;j++){var u=ffloor((UVQT[j]*sf+50)/100);1>u?u=1:u>255&&(u=255),UVTable[ZigZag[j]]=u}for(var aasf=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],k=0,row=0;8>row;row++)for(var col=0;8>col;col++)fdtbl_Y[k]=1/(YTable[ZigZag[k]]*aasf[row]*aasf[col]*8),fdtbl_UV[k]=1/(UVTable[ZigZag[k]]*aasf[row]*aasf[col]*8),k++}function computeHuffmanTbl(nrcodes,std_table){for(var codevalue=0,pos_in_table=0,HT=new Array,k=1;16>=k;k++){for(var j=1;j<=nrcodes[k];j++)HT[std_table[pos_in_table]]=[],HT[std_table[pos_in_table]][0]=codevalue,HT[std_table[pos_in_table]][1]=k,pos_in_table++,codevalue++;codevalue*=2}return HT}function initHuffmanTbl(){YDC_HT=computeHuffmanTbl(std_dc_luminance_nrcodes,std_dc_luminance_values),UVDC_HT=computeHuffmanTbl(std_dc_chrominance_nrcodes,std_dc_chrominance_values),YAC_HT=computeHuffmanTbl(std_ac_luminance_nrcodes,std_ac_luminance_values),UVAC_HT=computeHuffmanTbl(std_ac_chrominance_nrcodes,std_ac_chrominance_values)}function initCategoryNumber(){for(var nrlower=1,nrupper=2,cat=1;15>=cat;cat++){for(var nr=nrlower;nrupper>nr;nr++)category[32767+nr]=cat,bitcode[32767+nr]=[],bitcode[32767+nr][1]=cat,bitcode[32767+nr][0]=nr;for(var nrneg=-(nrupper-1);-nrlower>=nrneg;nrneg++)category[32767+nrneg]=cat,bitcode[32767+nrneg]=[],bitcode[32767+nrneg][1]=cat,bitcode[32767+nrneg][0]=nrupper-1+nrneg;nrlower<<=1,nrupper<<=1}}function initRGBYUVTable(){for(var i=0;256>i;i++)RGB_YUV_TABLE[i]=19595*i,RGB_YUV_TABLE[i+256>>0]=38470*i,RGB_YUV_TABLE[i+512>>0]=7471*i+32768,RGB_YUV_TABLE[i+768>>0]=-11059*i,RGB_YUV_TABLE[i+1024>>0]=-21709*i,RGB_YUV_TABLE[i+1280>>0]=32768*i+8421375,RGB_YUV_TABLE[i+1536>>0]=-27439*i,RGB_YUV_TABLE[i+1792>>0]=-5329*i}function writeBits(bs){for(var value=bs[0],posval=bs[1]-1;posval>=0;)value&1<<posval&&(bytenew|=1<<bytepos),posval--,bytepos--,0>bytepos&&(255==bytenew?(writeByte(255),writeByte(0)):writeByte(bytenew),bytepos=7,bytenew=0)}function writeByte(value){byteout.push(clt[value])}function writeWord(value){writeByte(value>>8&255),writeByte(255&value)}function fDCTQuant(data,fdtbl){var d0,d1,d2,d3,d4,d5,d6,d7,i,dataOff=0,I8=8,I64=64;for(i=0;I8>i;++i){d0=data[dataOff],d1=data[dataOff+1],d2=data[dataOff+2],d3=data[dataOff+3],d4=data[dataOff+4],d5=data[dataOff+5],d6=data[dataOff+6],d7=data[dataOff+7];var tmp0=d0+d7,tmp7=d0-d7,tmp1=d1+d6,tmp6=d1-d6,tmp2=d2+d5,tmp5=d2-d5,tmp3=d3+d4,tmp4=d3-d4,tmp10=tmp0+tmp3,tmp13=tmp0-tmp3,tmp11=tmp1+tmp2,tmp12=tmp1-tmp2;data[dataOff]=tmp10+tmp11,data[dataOff+4]=tmp10-tmp11;var z1=.707106781*(tmp12+tmp13);data[dataOff+2]=tmp13+z1,data[dataOff+6]=tmp13-z1,tmp10=tmp4+tmp5,tmp11=tmp5+tmp6,tmp12=tmp6+tmp7;var z5=.382683433*(tmp10-tmp12),z2=.5411961*tmp10+z5,z4=1.306562965*tmp12+z5,z3=.707106781*tmp11,z11=tmp7+z3,z13=tmp7-z3;data[dataOff+5]=z13+z2,data[dataOff+3]=z13-z2,data[dataOff+1]=z11+z4,data[dataOff+7]=z11-z4,dataOff+=8}for(dataOff=0,i=0;I8>i;++i){d0=data[dataOff],d1=data[dataOff+8],d2=data[dataOff+16],d3=data[dataOff+24],d4=data[dataOff+32],d5=data[dataOff+40],d6=data[dataOff+48],d7=data[dataOff+56];var tmp0p2=d0+d7,tmp7p2=d0-d7,tmp1p2=d1+d6,tmp6p2=d1-d6,tmp2p2=d2+d5,tmp5p2=d2-d5,tmp3p2=d3+d4,tmp4p2=d3-d4,tmp10p2=tmp0p2+tmp3p2,tmp13p2=tmp0p2-tmp3p2,tmp11p2=tmp1p2+tmp2p2,tmp12p2=tmp1p2-tmp2p2;data[dataOff]=tmp10p2+tmp11p2,data[dataOff+32]=tmp10p2-tmp11p2;var z1p2=.707106781*(tmp12p2+tmp13p2);data[dataOff+16]=tmp13p2+z1p2,data[dataOff+48]=tmp13p2-z1p2,tmp10p2=tmp4p2+tmp5p2,tmp11p2=tmp5p2+tmp6p2,tmp12p2=tmp6p2+tmp7p2;var z5p2=.382683433*(tmp10p2-tmp12p2),z2p2=.5411961*tmp10p2+z5p2,z4p2=1.306562965*tmp12p2+z5p2,z3p2=.707106781*tmp11p2,z11p2=tmp7p2+z3p2,z13p2=tmp7p2-z3p2;data[dataOff+40]=z13p2+z2p2,data[dataOff+24]=z13p2-z2p2,data[dataOff+8]=z11p2+z4p2,data[dataOff+56]=z11p2-z4p2,dataOff++}var fDCTQuant;for(i=0;I64>i;++i)fDCTQuant=data[i]*fdtbl[i],outputfDCTQuant[i]=fDCTQuant>0?fDCTQuant+.5|0:fDCTQuant-.5|0;return outputfDCTQuant}function writeAPP0(){writeWord(65504),writeWord(16),writeByte(74),writeByte(70),writeByte(73),writeByte(70),writeByte(0),writeByte(1),
writeByte(1),writeByte(0),writeWord(1),writeWord(1),writeByte(0),writeByte(0)}function writeSOF0(width,height){writeWord(65472),writeWord(17),writeByte(8),writeWord(height),writeWord(width),writeByte(3),writeByte(1),writeByte(17),writeByte(0),writeByte(2),writeByte(17),writeByte(1),writeByte(3),writeByte(17),writeByte(1)}function writeDQT(){writeWord(65499),writeWord(132),writeByte(0);for(var i=0;64>i;i++)writeByte(YTable[i]);writeByte(1);for(var j=0;64>j;j++)writeByte(UVTable[j])}function writeDHT(){writeWord(65476),writeWord(418),writeByte(0);for(var i=0;16>i;i++)writeByte(std_dc_luminance_nrcodes[i+1]);for(var j=0;11>=j;j++)writeByte(std_dc_luminance_values[j]);writeByte(16);for(var k=0;16>k;k++)writeByte(std_ac_luminance_nrcodes[k+1]);for(var l=0;161>=l;l++)writeByte(std_ac_luminance_values[l]);writeByte(1);for(var m=0;16>m;m++)writeByte(std_dc_chrominance_nrcodes[m+1]);for(var n=0;11>=n;n++)writeByte(std_dc_chrominance_values[n]);writeByte(17);for(var o=0;16>o;o++)writeByte(std_ac_chrominance_nrcodes[o+1]);for(var p=0;161>=p;p++)writeByte(std_ac_chrominance_values[p])}function writeSOS(){writeWord(65498),writeWord(12),writeByte(3),writeByte(1),writeByte(0),writeByte(2),writeByte(17),writeByte(3),writeByte(17),writeByte(0),writeByte(63),writeByte(0)}function processDU(CDU,fdtbl,DC,HTDC,HTAC){for(var pos,EOB=HTAC[0],M16zeroes=HTAC[240],I16=16,I63=63,I64=64,DU_DCT=fDCTQuant(CDU,fdtbl),j=0;I64>j;++j)DU[ZigZag[j]]=DU_DCT[j];var Diff=DU[0]-DC;DC=DU[0],0==Diff?writeBits(HTDC[0]):(pos=32767+Diff,writeBits(HTDC[category[pos]]),writeBits(bitcode[pos]));for(var end0pos=63;end0pos>0&&0==DU[end0pos];end0pos--);if(0==end0pos)return writeBits(EOB),DC;for(var lng,i=1;end0pos>=i;){for(var startpos=i;0==DU[i]&&end0pos>=i;++i);var nrzeroes=i-startpos;if(nrzeroes>=I16){lng=nrzeroes>>4;for(var nrmarker=1;lng>=nrmarker;++nrmarker)writeBits(M16zeroes);nrzeroes=15&nrzeroes}pos=32767+DU[i],writeBits(HTAC[(nrzeroes<<4)+category[pos]]),writeBits(bitcode[pos]),i++}return end0pos!=I63&&writeBits(EOB),DC}function initCharLookupTable(){for(var sfcc=String.fromCharCode,i=0;256>i;i++)clt[i]=sfcc(i)}function setQuality(quality){if(0>=quality&&(quality=1),quality>100&&(quality=100),currentQuality!=quality){var sf=0;sf=50>quality?Math.floor(5e3/quality):Math.floor(200-2*quality),initQuantTables(sf),currentQuality=quality}}function init(){quality||(quality=50),initCharLookupTable(),initHuffmanTbl(),initCategoryNumber(),initRGBYUVTable(),setQuality(quality)}var YDC_HT,UVDC_HT,YAC_HT,UVAC_HT,currentQuality,ffloor=(Math.round,Math.floor),YTable=new Array(64),UVTable=new Array(64),fdtbl_Y=new Array(64),fdtbl_UV=new Array(64),bitcode=new Array(65535),category=new Array(65535),outputfDCTQuant=new Array(64),DU=new Array(64),byteout=[],bytenew=0,bytepos=7,YDU=new Array(64),UDU=new Array(64),VDU=new Array(64),clt=new Array(256),RGB_YUV_TABLE=new Array(2048),ZigZag=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],std_dc_luminance_nrcodes=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],std_dc_luminance_values=[0,1,2,3,4,5,6,7,8,9,10,11],std_ac_luminance_nrcodes=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],std_ac_luminance_values=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],std_dc_chrominance_nrcodes=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],std_dc_chrominance_values=[0,1,2,3,4,5,6,7,8,9,10,11],std_ac_chrominance_nrcodes=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],std_ac_chrominance_values=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];this.encode=function(image,quality){quality&&setQuality(quality),byteout=new Array,bytenew=0,bytepos=7,writeWord(65496),writeAPP0(),writeDQT(),writeSOF0(image.width,image.height),writeDHT(),writeSOS();var DCY=0,DCU=0,DCV=0;bytenew=0,bytepos=7,this.encode.displayName="_encode_";for(var x,r,g,b,start,p,col,row,pos,imageData=image.data,width=image.width,height=image.height,quadWidth=4*width,y=0;height>y;){for(x=0;quadWidth>x;){for(start=quadWidth*y+x,p=start,col=-1,row=0,pos=0;64>pos;pos++)row=pos>>3,col=4*(7&pos),p=start+row*quadWidth+col,y+row>=height&&(p-=quadWidth*(y+1+row-height)),x+col>=quadWidth&&(p-=x+col-quadWidth+4),r=imageData[p++],g=imageData[p++],b=imageData[p++],YDU[pos]=(RGB_YUV_TABLE[r]+RGB_YUV_TABLE[g+256>>0]+RGB_YUV_TABLE[b+512>>0]>>16)-128,UDU[pos]=(RGB_YUV_TABLE[r+768>>0]+RGB_YUV_TABLE[g+1024>>0]+RGB_YUV_TABLE[b+1280>>0]>>16)-128,VDU[pos]=(RGB_YUV_TABLE[r+1280>>0]+RGB_YUV_TABLE[g+1536>>0]+RGB_YUV_TABLE[b+1792>>0]>>16)-128;DCY=processDU(YDU,fdtbl_Y,DCY,YDC_HT,YAC_HT),DCU=processDU(UDU,fdtbl_UV,DCU,UVDC_HT,UVAC_HT),DCV=processDU(VDU,fdtbl_UV,DCV,UVDC_HT,UVAC_HT),x+=32}y+=8}if(bytepos>=0){var fillbits=[];fillbits[1]=bytepos+1,fillbits[0]=(1<<bytepos+1)-1,writeBits(fillbits)}writeWord(65497);var jpegDataUri="data:image/jpeg;base64,"+btoa(byteout.join(""));return byteout=[],jpegDataUri},init()}return JPEGEncoder.encode=function(data,quality){var encoder=new JPEGEncoder(quality);return encoder.encode(data)},JPEGEncoder}),define("runtime/html5/androidpatch",["runtime/html5/util","runtime/html5/jpegencoder","base"],function(Util,encoder,Base){var supportJpeg,origin=Util.canvasToDataUrl;Util.canvasToDataUrl=function(canvas,type,quality){var ctx,w,h,fragement,parts;return Base.os.android?("image/jpeg"===type&&"undefined"==typeof supportJpeg&&(fragement=origin.apply(null,arguments),parts=fragement.split(","),fragement=~parts[0].indexOf("base64")?atob(parts[1]):decodeURIComponent(parts[1]),fragement=fragement.substring(0,2),supportJpeg=255===fragement.charCodeAt(0)&&216===fragement.charCodeAt(1)),"image/jpeg"!==type||supportJpeg?origin.apply(null,arguments):(w=canvas.width,h=canvas.height,ctx=canvas.getContext("2d"),encoder.encode(ctx.getImageData(0,0,w,h),quality))):origin.apply(null,arguments)}}),define("runtime/html5/image",["base","runtime/html5/runtime","runtime/html5/util"],function(Base,Html5Runtime,Util){var BLANK="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D";return Html5Runtime.register("Image",{modified:!1,init:function(){var me=this,img=new Image;img.onload=function(){me._info={type:me.type,width:this.width,height:this.height},me._metas||"image/jpeg"!==me.type?me.owner.trigger("load"):Util.parseMeta(me._blob,function(error,ret){me._metas=ret,me.owner.trigger("load")})},img.onerror=function(){me.owner.trigger("error")},me._img=img},loadFromBlob:function(blob){var me=this,img=me._img;me._blob=blob,me.type=blob.type,img.src=Util.createObjectURL(blob.getSource()),me.owner.once("load",function(){Util.revokeObjectURL(img.src)})},resize:function(width,height){var canvas=this._canvas||(this._canvas=document.createElement("canvas"));this._resize(this._img,canvas,width,height),this._blob=null,this.modified=!0,this.owner.trigger("complete","resize")},crop:function(x,y,w,h,s){var cvs=this._canvas||(this._canvas=document.createElement("canvas")),opts=this.options,img=this._img,iw=img.naturalWidth,ih=img.naturalHeight,orientation=this.getOrientation();s=s||1,cvs.width=w,cvs.height=h,opts.preserveHeaders||this._rotate2Orientaion(cvs,orientation),this._renderImageToCanvas(cvs,img,-x,-y,iw*s,ih*s),this._blob=null,this.modified=!0,this.owner.trigger("complete","crop")},getAsBlob:function(type){var canvas,blob=this._blob,opts=this.options;if(type=type||this.type,this.modified||this.type!==type){if(canvas=this._canvas,"image/jpeg"===type){if(blob=Util.canvasToDataUrl(canvas,type,opts.quality),opts.preserveHeaders&&this._metas&&this._metas.imageHead)return blob=Util.dataURL2ArrayBuffer(blob),blob=Util.updateImageHead(blob,this._metas.imageHead),blob=Util.arrayBufferToBlob(blob,type)}else blob=Util.canvasToDataUrl(canvas,type);blob=Util.dataURL2Blob(blob)}return blob},getAsDataUrl:function(type){var opts=this.options;return type=type||this.type,"image/jpeg"===type?Util.canvasToDataUrl(this._canvas,type,opts.quality):this._canvas.toDataURL(type)},getOrientation:function(){return this._metas&&this._metas.exif&&this._metas.exif.get("Orientation")||1},info:function(val){return val?(this._info=val,this):this._info},meta:function(val){return val?(this._metas=val,this):this._metas},destroy:function(){var canvas=this._canvas;this._img.onload=null,canvas&&(canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height),canvas.width=canvas.height=0,this._canvas=null),this._img.src=BLANK,this._img=this._blob=null},_resize:function(img,cvs,width,height){var scale,w,h,x,y,opts=this.options,naturalWidth=img.width,naturalHeight=img.height,orientation=this.getOrientation();~[5,6,7,8].indexOf(orientation)&&(width^=height,height^=width,width^=height),scale=Math[opts.crop?"max":"min"](width/naturalWidth,height/naturalHeight),opts.allowMagnify||(scale=Math.min(1,scale)),w=naturalWidth*scale,h=naturalHeight*scale,opts.crop?(cvs.width=width,cvs.height=height):(cvs.width=w,cvs.height=h),x=(cvs.width-w)/2,y=(cvs.height-h)/2,opts.preserveHeaders||this._rotate2Orientaion(cvs,orientation),this._renderImageToCanvas(cvs,img,x,y,w,h)},_rotate2Orientaion:function(canvas,orientation){var width=canvas.width,height=canvas.height,ctx=canvas.getContext("2d");switch(orientation){case 5:case 6:case 7:case 8:canvas.width=height,canvas.height=width}switch(orientation){case 2:ctx.translate(width,0),ctx.scale(-1,1);break;case 3:ctx.translate(width,height),ctx.rotate(Math.PI);break;case 4:ctx.translate(0,height),ctx.scale(1,-1);break;case 5:ctx.rotate(.5*Math.PI),ctx.scale(1,-1);break;case 6:ctx.rotate(.5*Math.PI),ctx.translate(0,-height);break;case 7:ctx.rotate(.5*Math.PI),ctx.translate(width,-height),ctx.scale(-1,1);break;case 8:ctx.rotate(-.5*Math.PI),ctx.translate(-width,0)}},_renderImageToCanvas:function(){function detectVerticalSquash(img,iw,ih){var data,alpha,ratio,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),sy=0,ey=ih,py=ih;for(canvas.width=1,canvas.height=ih,ctx.drawImage(img,0,0),data=ctx.getImageData(0,0,1,ih).data;py>sy;)alpha=data[4*(py-1)+3],0===alpha?ey=py:sy=py,py=ey+sy>>1;return ratio=py/ih,0===ratio?1:ratio}function detectSubsampling(img){var canvas,ctx,iw=img.naturalWidth,ih=img.naturalHeight;return iw*ih>1048576?(canvas=document.createElement("canvas"),canvas.width=canvas.height=1,ctx=canvas.getContext("2d"),ctx.drawImage(img,-iw+1,0),0===ctx.getImageData(0,0,1,1).data[3]):!1}return Base.os.ios?Base.os.ios>=7?function(canvas,img,x,y,w,h){var iw=img.naturalWidth,ih=img.naturalHeight,vertSquashRatio=detectVerticalSquash(img,iw,ih);return canvas.getContext("2d").drawImage(img,0,0,iw*vertSquashRatio,ih*vertSquashRatio,x,y,w,h)}:function(canvas,img,x,y,width,height){var tmpCanvas,tmpCtx,vertSquashRatio,dw,dh,sx,dx,iw=img.naturalWidth,ih=img.naturalHeight,ctx=canvas.getContext("2d"),subsampled=detectSubsampling(img),doSquash="image/jpeg"===this.type,d=1024,sy=0,dy=0;for(subsampled&&(iw/=2,ih/=2),ctx.save(),tmpCanvas=document.createElement("canvas"),tmpCanvas.width=tmpCanvas.height=d,tmpCtx=tmpCanvas.getContext("2d"),vertSquashRatio=doSquash?detectVerticalSquash(img,iw,ih):1,dw=Math.ceil(d*width/iw),dh=Math.ceil(d*height/ih/vertSquashRatio);ih>sy;){for(sx=0,dx=0;iw>sx;)tmpCtx.clearRect(0,0,d,d),tmpCtx.drawImage(img,-sx,-sy),ctx.drawImage(tmpCanvas,0,0,d,d,x+dx,y+dy,dw,dh),sx+=d,dx+=dw;sy+=d,dy+=dh}ctx.restore(),tmpCanvas=tmpCtx=null}:function(canvas){var args=Base.slice(arguments,1),ctx=canvas.getContext("2d");ctx.drawImage.apply(ctx,args)}}()})}),define("runtime/html5/transport",["base","runtime/html5/runtime"],function(Base,Html5Runtime){var noop=Base.noop,$=Base.$;return Html5Runtime.register("Transport",{init:function(){this._status=0,this._response=null},send:function(){var formData,binary,fr,owner=this.owner,opts=this.options,xhr=this._initAjax(),blob=owner._blob,server=opts.server;opts.sendAsBinary?(server+=(/\?/.test(server)?"&":"?")+$.param(owner._formData),binary=blob.getSource()):(formData=new FormData,$.each(owner._formData,function(k,v){formData.append(k,v)}),formData.append(opts.fileVal,blob.getSource(),opts.filename||owner._formData.name||"")),opts.withCredentials&&"withCredentials"in xhr?(xhr.open(opts.method,server,!0),xhr.withCredentials=!0):xhr.open(opts.method,server),this._setRequestHeader(xhr,opts.headers),binary?(xhr.overrideMimeType&&xhr.overrideMimeType("application/octet-stream"),Base.os.android?(fr=new FileReader,fr.onload=function(){xhr.send(this.result),fr=fr.onload=null},fr.readAsArrayBuffer(binary)):xhr.send(binary)):xhr.send(formData)},getResponse:function(){return this._response},getResponseAsJson:function(){return this._parseJson(this._response)},getStatus:function(){return this._status},abort:function(){var xhr=this._xhr;xhr&&(xhr.upload.onprogress=noop,xhr.onreadystatechange=noop,xhr.abort(),this._xhr=xhr=null)},destroy:function(){this.abort()},_initAjax:function(){var me=this,xhr=new XMLHttpRequest,opts=this.options;return!opts.withCredentials||"withCredentials"in xhr||"undefined"==typeof XDomainRequest||(xhr=new XDomainRequest),xhr.upload.onprogress=function(e){var percentage=0;return e.lengthComputable&&(percentage=e.loaded/e.total),me.trigger("progress",percentage)},xhr.onreadystatechange=function(){return 4===xhr.readyState?(xhr.upload.onprogress=noop,xhr.onreadystatechange=noop,me._xhr=null,me._status=xhr.status,xhr.status>=200&&xhr.status<300?(me._response=xhr.responseText,me.trigger("load")):xhr.status>=500&&xhr.status<600?(me._response=xhr.responseText,me.trigger("error","server")):me.trigger("error",me._status?"http":"abort")):void 0},me._xhr=xhr,xhr},_setRequestHeader:function(xhr,headers){$.each(headers,function(key,val){xhr.setRequestHeader(key,val)})},_parseJson:function(str){var json;try{json=JSON.parse(str)}catch(ex){json={}}return json}})}),define("runtime/html5/md5",["runtime/html5/runtime"],function(FlashRuntime){var add32=function(a,b){return a+b&4294967295},cmn=function(q,a,b,x,s,t){return a=add32(add32(a,q),add32(x,t)),add32(a<<s|a>>>32-s,b)},ff=function(a,b,c,d,x,s,t){return cmn(b&c|~b&d,a,b,x,s,t)},gg=function(a,b,c,d,x,s,t){return cmn(b&d|c&~d,a,b,x,s,t)},hh=function(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)},ii=function(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t)},md5cycle=function(x,k){var a=x[0],b=x[1],c=x[2],d=x[3];a=ff(a,b,c,d,k[0],7,-680876936),d=ff(d,a,b,c,k[1],12,-389564586),c=ff(c,d,a,b,k[2],17,606105819),b=ff(b,c,d,a,k[3],22,-1044525330),a=ff(a,b,c,d,k[4],7,-176418897),d=ff(d,a,b,c,k[5],12,1200080426),c=ff(c,d,a,b,k[6],17,-1473231341),b=ff(b,c,d,a,k[7],22,-45705983),a=ff(a,b,c,d,k[8],7,1770035416),d=ff(d,a,b,c,k[9],12,-1958414417),c=ff(c,d,a,b,k[10],17,-42063),b=ff(b,c,d,a,k[11],22,-1990404162),a=ff(a,b,c,d,k[12],7,1804603682),d=ff(d,a,b,c,k[13],12,-40341101),c=ff(c,d,a,b,k[14],17,-1502002290),b=ff(b,c,d,a,k[15],22,1236535329),a=gg(a,b,c,d,k[1],5,-165796510),d=gg(d,a,b,c,k[6],9,-1069501632),c=gg(c,d,a,b,k[11],14,643717713),b=gg(b,c,d,a,k[0],20,-373897302),a=gg(a,b,c,d,k[5],5,-701558691),d=gg(d,a,b,c,k[10],9,38016083),c=gg(c,d,a,b,k[15],14,-660478335),b=gg(b,c,d,a,k[4],20,-405537848),a=gg(a,b,c,d,k[9],5,568446438),d=gg(d,a,b,c,k[14],9,-1019803690),c=gg(c,d,a,b,k[3],14,-187363961),b=gg(b,c,d,a,k[8],20,1163531501),a=gg(a,b,c,d,k[13],5,-1444681467),d=gg(d,a,b,c,k[2],9,-51403784),c=gg(c,d,a,b,k[7],14,1735328473),b=gg(b,c,d,a,k[12],20,-1926607734),a=hh(a,b,c,d,k[5],4,-378558),d=hh(d,a,b,c,k[8],11,-2022574463),c=hh(c,d,a,b,k[11],16,1839030562),b=hh(b,c,d,a,k[14],23,-35309556),a=hh(a,b,c,d,k[1],4,-1530992060),d=hh(d,a,b,c,k[4],11,1272893353),c=hh(c,d,a,b,k[7],16,-155497632),b=hh(b,c,d,a,k[10],23,-1094730640),a=hh(a,b,c,d,k[13],4,681279174),d=hh(d,a,b,c,k[0],11,-358537222),c=hh(c,d,a,b,k[3],16,-722521979),b=hh(b,c,d,a,k[6],23,76029189),a=hh(a,b,c,d,k[9],4,-640364487),d=hh(d,a,b,c,k[12],11,-421815835),c=hh(c,d,a,b,k[15],16,530742520),b=hh(b,c,d,a,k[2],23,-995338651),a=ii(a,b,c,d,k[0],6,-198630844),d=ii(d,a,b,c,k[7],10,1126891415),c=ii(c,d,a,b,k[14],15,-1416354905),b=ii(b,c,d,a,k[5],21,-57434055),a=ii(a,b,c,d,k[12],6,1700485571),d=ii(d,a,b,c,k[3],10,-1894986606),c=ii(c,d,a,b,k[10],15,-1051523),b=ii(b,c,d,a,k[1],21,-2054922799),a=ii(a,b,c,d,k[8],6,1873313359),d=ii(d,a,b,c,k[15],10,-30611744),c=ii(c,d,a,b,k[6],15,-1560198380),b=ii(b,c,d,a,k[13],21,1309151649),a=ii(a,b,c,d,k[4],6,-145523070),d=ii(d,a,b,c,k[11],10,-1120210379),c=ii(c,d,a,b,k[2],15,718787259),b=ii(b,c,d,a,k[9],21,-343485551),x[0]=add32(a,x[0]),x[1]=add32(b,x[1]),x[2]=add32(c,x[2]),x[3]=add32(d,x[3])},md5blk=function(s){var i,md5blks=[];for(i=0;64>i;i+=4)md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24);return md5blks},md5blk_array=function(a){var i,md5blks=[];for(i=0;64>i;i+=4)md5blks[i>>2]=a[i]+(a[i+1]<<8)+(a[i+2]<<16)+(a[i+3]<<24);return md5blks},md51=function(s){var i,length,tail,tmp,lo,hi,n=s.length,state=[1732584193,-271733879,-1732584194,271733878];for(i=64;n>=i;i+=64)md5cycle(state,md5blk(s.substring(i-64,i)));for(s=s.substring(i-64),length=s.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=0;length>i;i+=1)tail[i>>2]|=s.charCodeAt(i)<<(i%4<<3);if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(state,tail),i=0;16>i;i+=1)tail[i]=0;return tmp=8*n,tmp=tmp.toString(16).match(/(.*?)(.{0,8})$/),lo=parseInt(tmp[2],16),hi=parseInt(tmp[1],16)||0,tail[14]=lo,tail[15]=hi,md5cycle(state,tail),state},md51_array=function(a){var i,length,tail,tmp,lo,hi,n=a.length,state=[1732584193,-271733879,-1732584194,271733878];for(i=64;n>=i;i+=64)md5cycle(state,md5blk_array(a.subarray(i-64,i)));for(a=n>i-64?a.subarray(i-64):new Uint8Array(0),length=a.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=0;length>i;i+=1)tail[i>>2]|=a[i]<<(i%4<<3);if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(state,tail),i=0;16>i;i+=1)tail[i]=0;return tmp=8*n,tmp=tmp.toString(16).match(/(.*?)(.{0,8})$/),lo=parseInt(tmp[2],16),hi=parseInt(tmp[1],16)||0,tail[14]=lo,tail[15]=hi,md5cycle(state,tail),state},hex_chr=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],rhex=function(n){var j,s="";for(j=0;4>j;j+=1)s+=hex_chr[n>>8*j+4&15]+hex_chr[n>>8*j&15];return s},hex=function(x){var i;for(i=0;i<x.length;i+=1)x[i]=rhex(x[i]);return x.join("")},md5=function(s){return hex(md51(s))},SparkMD5=function(){this.reset()};return"5d41402abc4b2a76b9719d911017c592"!==md5("hello")&&(add32=function(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}),SparkMD5.prototype.append=function(str){return/[\u0080-\uFFFF]/.test(str)&&(str=unescape(encodeURIComponent(str))),this.appendBinary(str),this},SparkMD5.prototype.appendBinary=function(contents){this._buff+=contents,this._length+=contents.length;var i,length=this._buff.length;for(i=64;length>=i;i+=64)md5cycle(this._state,md5blk(this._buff.substring(i-64,i)));return this._buff=this._buff.substr(i-64),this},SparkMD5.prototype.end=function(raw){var i,ret,buff=this._buff,length=buff.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;length>i;i+=1)tail[i>>2]|=buff.charCodeAt(i)<<(i%4<<3);return this._finish(tail,length),ret=raw?this._state:hex(this._state),this.reset(),ret},SparkMD5.prototype._finish=function(tail,length){var tmp,lo,hi,i=length;if(tail[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(this._state,tail),i=0;16>i;i+=1)tail[i]=0;tmp=8*this._length,tmp=tmp.toString(16).match(/(.*?)(.{0,8})$/),lo=parseInt(tmp[2],16),hi=parseInt(tmp[1],16)||0,tail[14]=lo,tail[15]=hi,md5cycle(this._state,tail)},SparkMD5.prototype.reset=function(){return this._buff="",this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this},SparkMD5.prototype.destroy=function(){delete this._state,delete this._buff,delete this._length},SparkMD5.hash=function(str,raw){/[\u0080-\uFFFF]/.test(str)&&(str=unescape(encodeURIComponent(str)));var hash=md51(str);return raw?hash:hex(hash)},SparkMD5.hashBinary=function(content,raw){var hash=md51(content);return raw?hash:hex(hash)},SparkMD5.ArrayBuffer=function(){this.reset()},SparkMD5.ArrayBuffer.prototype.append=function(arr){var i,buff=this._concatArrayBuffer(this._buff,arr),length=buff.length;for(this._length+=arr.byteLength,i=64;length>=i;i+=64)md5cycle(this._state,md5blk_array(buff.subarray(i-64,i)));return this._buff=length>i-64?buff.subarray(i-64):new Uint8Array(0),this},SparkMD5.ArrayBuffer.prototype.end=function(raw){var i,ret,buff=this._buff,length=buff.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;length>i;i+=1)tail[i>>2]|=buff[i]<<(i%4<<3);return this._finish(tail,length),ret=raw?this._state:hex(this._state),this.reset(),ret},SparkMD5.ArrayBuffer.prototype._finish=SparkMD5.prototype._finish,SparkMD5.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._state=[1732584193,-271733879,-1732584194,271733878],this},SparkMD5.ArrayBuffer.prototype.destroy=SparkMD5.prototype.destroy,SparkMD5.ArrayBuffer.prototype._concatArrayBuffer=function(first,second){var firstLength=first.length,result=new Uint8Array(firstLength+second.byteLength);return result.set(first),result.set(new Uint8Array(second),firstLength),result},SparkMD5.ArrayBuffer.hash=function(arr,raw){var hash=md51_array(new Uint8Array(arr));return raw?hash:hex(hash)},FlashRuntime.register("Md5",{init:function(){},loadFromBlob:function(file){var loadNext,fr,blob=file.getSource(),chunkSize=2097152,chunks=Math.ceil(blob.size/chunkSize),chunk=0,owner=this.owner,spark=new SparkMD5.ArrayBuffer,me=this,blobSlice=blob.mozSlice||blob.webkitSlice||blob.slice;fr=new FileReader,(loadNext=function(){var start,end;start=chunk*chunkSize,end=Math.min(start+chunkSize,blob.size),fr.onload=function(e){spark.append(e.target.result),owner.trigger("progress",{total:file.size,loaded:end})},fr.onloadend=function(){fr.onloadend=fr.onload=null,++chunk<chunks?setTimeout(loadNext,1):setTimeout(function(){owner.trigger("load"),me.result=spark.end(),loadNext=file=blob=spark=null,owner.trigger("complete")},50)},fr.readAsArrayBuffer(blobSlice.call(blob,start,end))})()},getResult:function(){return this.result}})}),define("runtime/flash/runtime",["base","runtime/runtime","runtime/compbase"],function(Base,Runtime,CompBase){function getFlashVersion(){var version;try{version=navigator.plugins["Shockwave Flash"],version=version.description}catch(ex){try{version=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(ex2){version="0.0"}}return version=version.match(/\d+/g),parseFloat(version[0]+"."+version[1],10)}function FlashRuntime(){function handler(evt,obj){var parts,uid,type=evt.type||evt;parts=type.split("::"),uid=parts[0],type=parts[1],"Ready"===type&&uid===me.uid?me.trigger("ready"):clients[uid]&&clients[uid].trigger(type.toLowerCase(),evt,obj)}var pool={},clients={},destroy=this.destroy,me=this,jsreciver=Base.guid("webuploader_");Runtime.apply(me,arguments),me.type=type,me.exec=function(comp,fn){var instance,client=this,uid=client.uid,args=Base.slice(arguments,2);return clients[uid]=client,components[comp]&&(pool[uid]||(pool[uid]=new components[comp](client,me)),instance=pool[uid],instance[fn])?instance[fn].apply(instance,args):me.flashExec.apply(client,arguments)},window[jsreciver]=function(){var args=arguments;setTimeout(function(){handler.apply(null,args)},1)},this.jsreciver=jsreciver,this.destroy=function(){return destroy&&destroy.apply(this,arguments)},this.flashExec=function(comp,fn){var flash=me.getFlash(),args=Base.slice(arguments,2);return flash.exec(this.uid,comp,fn,args)}}var $=Base.$,type="flash",components={};return Base.inherits(Runtime,{constructor:FlashRuntime,init:function(){var html,container=this.getContainer(),opts=this.options;container.css({position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"}),html='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+opts.swf+'" ',Base.browser.ie&&(html+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),html+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+opts.swf+'" /><param name="flashvars" value="uid='+this.uid+"&jsreciver="+this.jsreciver+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',container.html(html)},getFlash:function(){return this._flash?this._flash:(this._flash=$("#"+this.uid).get(0),this._flash)}}),FlashRuntime.register=function(name,component){return component=components[name]=Base.inherits(CompBase,$.extend({flashExec:function(){var owner=this.owner,runtime=this.getRuntime();return runtime.flashExec.apply(owner,arguments)}},component))},getFlashVersion()>=11.4&&Runtime.addRuntime(type,FlashRuntime),FlashRuntime}),define("runtime/flash/filepicker",["base","runtime/flash/runtime"],function(Base,FlashRuntime){var $=Base.$;return FlashRuntime.register("FilePicker",{init:function(opts){var len,i,copy=$.extend({},opts);for(len=copy.accept&&copy.accept.length,i=0;len>i;i++)copy.accept[i].title||(copy.accept[i].title="Files");delete copy.button,delete copy.id,delete copy.container,this.flashExec("FilePicker","init",copy)},destroy:function(){this.flashExec("FilePicker","destroy")}})}),define("runtime/flash/image",["runtime/flash/runtime"],function(FlashRuntime){return FlashRuntime.register("Image",{loadFromBlob:function(blob){var owner=this.owner;owner.info()&&this.flashExec("Image","info",owner.info()),owner.meta()&&this.flashExec("Image","meta",owner.meta()),this.flashExec("Image","loadFromBlob",blob.uid)}})}),define("runtime/flash/transport",["base","runtime/flash/runtime","runtime/client"],function(Base,FlashRuntime,RuntimeClient){var $=Base.$;return FlashRuntime.register("Transport",{init:function(){this._status=0,this._response=null,this._responseJson=null},send:function(){var binary,owner=this.owner,opts=this.options,xhr=this._initAjax(),blob=owner._blob,server=opts.server;xhr.connectRuntime(blob.ruid),opts.sendAsBinary?(server+=(/\?/.test(server)?"&":"?")+$.param(owner._formData),binary=blob.uid):($.each(owner._formData,function(k,v){xhr.exec("append",k,v)}),xhr.exec("appendBlob",opts.fileVal,blob.uid,opts.filename||owner._formData.name||"")),this._setRequestHeader(xhr,opts.headers),xhr.exec("send",{method:opts.method,url:server,forceURLStream:opts.forceURLStream,mimeType:"application/octet-stream"},binary)},getStatus:function(){return this._status},getResponse:function(){return this._response||""},getResponseAsJson:function(){return this._responseJson},abort:function(){var xhr=this._xhr;xhr&&(xhr.exec("abort"),xhr.destroy(),this._xhr=xhr=null)},destroy:function(){this.abort()},_initAjax:function(){var me=this,xhr=new RuntimeClient("XMLHttpRequest");return xhr.on("uploadprogress progress",function(e){var percent=e.loaded/e.total;return percent=Math.min(1,Math.max(0,percent)),me.trigger("progress",percent)}),xhr.on("load",function(){var p,status=xhr.exec("getStatus"),readBody=!1,err="";return xhr.off(),me._xhr=null,status>=200&&300>status?readBody=!0:status>=500&&600>status?(readBody=!0,err="server"):err="http",readBody&&(me._response=xhr.exec("getResponse"),me._response=decodeURIComponent(me._response),p=function(s){try{return window.JSON&&window.JSON.parse?JSON.parse(s):new Function("return "+s).call()}catch(err){return{}}},me._responseJson=me._response?p(me._response):{}),xhr.destroy(),xhr=null,err?me.trigger("error",err):me.trigger("load")}),xhr.on("error",function(){xhr.off(),me._xhr=null,me.trigger("error","http")}),me._xhr=xhr,xhr},_setRequestHeader:function(xhr,headers){$.each(headers,function(key,val){xhr.exec("setRequestHeader",key,val)})}})}),define("runtime/flash/blob",["runtime/flash/runtime","lib/blob"],function(FlashRuntime,Blob){return FlashRuntime.register("Blob",{slice:function(start,end){var blob=this.flashExec("Blob","slice",start,end);return new Blob(this.getRuid(),blob)}})}),define("runtime/flash/md5",["runtime/flash/runtime"],function(FlashRuntime){return FlashRuntime.register("Md5",{init:function(){},loadFromBlob:function(blob){return this.flashExec("Md5","loadFromBlob",blob.uid)}})}),define("preset/all",["base","widgets/filednd","widgets/filepaste","widgets/filepicker","widgets/image","widgets/queue","widgets/runtime","widgets/upload","widgets/validator","widgets/md5","runtime/html5/blob","runtime/html5/dnd","runtime/html5/filepaste","runtime/html5/filepicker","runtime/html5/imagemeta/exif","runtime/html5/androidpatch","runtime/html5/image","runtime/html5/transport","runtime/html5/md5","runtime/flash/filepicker","runtime/flash/image","runtime/flash/transport","runtime/flash/blob","runtime/flash/md5"],function(Base){return Base}),define("widgets/log",["base","uploader","widgets/widget"],function(Base,Uploader){function send(data){var obj=$.extend({},base,data),url=logUrl.replace(/^(.*)\?/,"$1"+$.param(obj)),image=new Image;image.src=url}var base,$=Base.$,logUrl=" http://static.tieba.baidu.com/tb/pms/img/st.gif??",product=(location.hostname||location.host||"protected").toLowerCase(),enable=product&&/baidu/i.exec(product);if(enable)return base={dv:3,master:"webuploader",online:/test/.exec(product)?0:1,module:"",product:product,type:0},Uploader.register({name:"log",init:function(){var owner=this.owner,count=0,size=0;owner.on("error",function(code){send({type:2,c_error_code:code})}).on("uploadError",function(file,reason){send({type:2,c_error_code:"UPLOAD_ERROR",c_reason:""+reason})}).on("uploadComplete",function(file){count++,size+=file.size}).on("uploadFinished",function(){send({c_count:count,c_size:size}),count=size=0}),send({c_usage:1})}})}),define("webuploader/webuploader",["preset/all","widgets/log"],function(preset){return preset}),require("webuploader/webuploader")});